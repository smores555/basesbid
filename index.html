<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Position Bid Simulator — Delta Mode</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8aa4c1; --text:#eaf2ff; --accent:#8ad2ff; --border:#1f2a44; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:0 12px 42px}
    h1{font-size:22px;margin:0 0 10px;color:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0}
    button{background:#2e4a78;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.secondary{background:#203453}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    td{background:#0f182a;border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
    .basehdr{background:#13213a;color:#cfe6ff;font-weight:700}
    input[type=number]{width:70px;padding:6px;border-radius:8px;border:1px solid var(--border);background:#0b1426;color:var(--text);font-size:14px}
    .buts>button{padding:4px 8px;border-radius:8px;margin-left:2px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1.2fr 1fr} }
    details{margin:10px 0}
    summary{cursor:pointer}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a2a47;color:#c8ddff;font-size:12px;margin-right:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Position Bid Simulator — Delta Adjustments</h1>

    <div class="card">
      <div class="toolbar">
        <button id="runBtn">Run Simulation</button>
        <button class="secondary" id="resetBtn">Reset All Δ</button>
        <span id="status" style="margin-left:8px;color:var(--muted);"></span>
      </div>
      <div id="capTable"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Summary</h3>
        <div id="summary"></div>
      </div>
      <div class="card">
        <h3>Moves</h3>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    let capacitiesRaw = [];
    let roster = [];
    let prefs = {};
    let capMap = new Map(); // key -> {base, seat, start, delta}

    const keyOf = (b,s)=>`${b}_${s}`;

    async function loadAll(){
      async function safeFetch(path){ try { const r = await fetch(path); if(!r.ok) throw 0; return r.json(); } catch{ return null; } }
      capacitiesRaw = await safeFetch('capacities.json') || await safeFetch('data/capacities.json') || await safeFetch('capacities.json.txt') || await safeFetch('data/capacities.json.txt');
      roster        = await safeFetch('roster.json')      || await safeFetch('data/roster.json');
      prefs         = await safeFetch('preferences.json') || await safeFetch('data/preferences.json');

      if(!capacitiesRaw || !roster || !prefs){
        document.getElementById('status').textContent = 'Could not load one or more JSON files.';
        return;
      }

      capMap.clear();
      for(const c of capacitiesRaw){
        const start = (c.startCapacity||0) + (+c.delta||0);
        const k = keyOf(c.base, c.seat);
        capMap.set(k, { base:c.base, seat:c.seat, start:start, delta:0 });
      }
      renderCapTable();
    }

    function groupByBase(){
      const bases = {};
      for(const {base, seat} of capMap.values()){
        if(!bases[base]) bases[base] = new Set();
        bases[base].add(seat);
      }
      const orderSeat = (a,b)=> (a===b?0 : a==='CA'? -1 : b==='CA'? 1 : a.localeCompare(b));
      return Object.keys(bases).sort().map(base=>({ base, seats: Array.from(bases[base]).sort(orderSeat) }));
    }

    function renderCapTable(){
      const groups = groupByBase();
      let html = '<table><thead><tr><th>Base</th><th>Seat</th><th>Start</th><th>Δ</th><th>Adjusted</th><th></th></tr></thead><tbody>';
      for(const g of groups){
        const rowSpan = g.seats.length;
        g.seats.forEach((seat, idx)=>{
          const k = keyOf(g.base, seat);
          const cap = capMap.get(k);
          const inputId = `cap_${k}`;
          const adjusted = cap.start + cap.delta;
          html += '<tr>';
          if(idx===0){ html += `<td class="basehdr" rowspan="${rowSpan}">${g.base}</td>`; }
          html += `<td>${seat}</td>`;
          html += `<td>${cap.start}</td>`;
          html += `<td><input type="number" id="${inputId}" value="${cap.delta}" oninput="onCapInput('${k}', this.value)"></td>`;
          html += `<td>${adjusted}</td>`;
          html += `<td class="buts">`+
                  `<button onclick="bump('${k}',-10)">-10</button>`+
                  `<button onclick="bump('${k}',-5)">-5</button>`+
                  `<button onclick="bump('${k}',-1)">-1</button>`+
                  `<button onclick="bump('${k}',+1)">+1</button>`+
                  `<button onclick="bump('${k}',+5)">+5</button>`+
                  `<button onclick="bump('${k}',+10)">+10</button>`+
                  `</td>`;
          html += '</tr>';
        });
      }
      html += '</tbody></table>';
      document.getElementById('capTable').innerHTML = html;
      document.getElementById('status').textContent = 'Δ values applied on top of Start capacities.';
    }

    function onCapInput(k, v){
      const n = parseInt(v||'0',10);
      const cap = capMap.get(k); cap.delta = n;
      renderCapTable();
    }

    function bump(k, d){
      const cap = capMap.get(k);
      cap.delta = (cap.delta|0) + d;
      renderCapTable();
    }

    function resetCaps(){
      for(const cap of capMap.values()) cap.delta = 0;
      renderCapTable();
    }

    function run(){
      const remain = new Map();
      for(const [k, cap] of capMap.entries()) remain.set(k, cap.start + cap.delta);

      const sorted = [...roster].sort((a,b)=>a.sen - b.sen);
      const assignments = new Map();
      const moves = [];
      const upgrades = [];

      function assignIfCap(base, seat){
        const k = keyOf(base, seat);
        if(!remain.has(k)) return false;
        if(remain.get(k) <= 0) return false;
        remain.set(k, remain.get(k) - 1);
        return true;
      }

      for(const p of sorted){
        const pref = (prefs[p.id]?.preferences)||[];
        let chosen = null;
        const stayPref = pref.find(x=>x.stay === true || x.bpl_min === 0);
        if(stayPref){
          if(assignIfCap(p.current.base, p.current.seat)){
            chosen = { base:p.current.base, seat:p.current.seat };
          }
        }
        if(!chosen){
          const wanted = [...pref].filter(x=>!x.stay && x.bpl_min !== 0)
                                  .sort((a,b)=>(a.order||0)-(b.order||0));
          for(const w of wanted){
            if(assignIfCap(w.base, w.seat)){
              chosen = { base:w.base, seat:w.seat };
              break;
            }
          }
        }
        if(!chosen){
          if(assignIfCap(p.current.base, p.current.seat)){
            chosen = { base:p.current.base, seat:p.current.seat };
          } else {
            for(const [k,_v] of remain.entries()){
              if(remain.get(k)>0){
                const [b,s]=k.split('_');
                assignIfCap(b,s);
                chosen = { base:b, seat:s };
                break;
              }
            }
          }
        }
        assignments.set(p.id, chosen);
        if(chosen.base!==p.current.base || chosen.seat!==p.current.seat){
          moves.push({sen:p.sen, name:p.name, from:`${p.current.base} ${p.current.seat}` , to:`${chosen.base} ${chosen.seat}`});
        }
        if(p.current.seat==='FO' && chosen.seat==='CA'){
          upgrades.push({sen:p.sen, name:p.name, base:chosen.base});
        }
      }

      const resEl = document.getElementById('results');
      let html = `<div class="pill">Total moves: ${moves.length}</div>`;
      html += `<div class="pill">Upgrades (FO→CA): ${upgrades.length}</div>`;
      html += '<details open><summary>All Moves</summary><ol>';
      for(const m of moves){
        html += `<li>${m.sen} ${m.name}: ${m.from} → <b>${m.to}</b></li>`;
      }
      html += '</ol></details>';
      resEl.innerHTML = html;

      const summaryEl = document.getElementById('summary');
      let shtml = '<table><thead><tr><th>Base</th><th>Seat</th><th>Start</th><th>Δ</th><th>Adjusted</th><th>Filled</th></tr></thead><tbody>';
      const fill = new Map();
      for(const [pid, a] of assignments.entries()){
        const k = keyOf(a.base,a.seat);
        fill.set(k, (fill.get(k)||0)+1);
      }
      for(const [k, cap] of capMap.entries()){
        const adjusted = cap.start + cap.delta;
        const f = fill.get(k)||0;
        shtml += `<tr><td>${cap.base}</td><td>${cap.seat}</td><td>${cap.start}</td><td>${cap.delta}</td><td>${adjusted}</td><td>${f}</td></tr>`;
      }
      shtml += '</tbody></table>';
      summaryEl.innerHTML = shtml;

      document.getElementById('status').textContent = 'Simulation complete.';
    }

    document.getElementById('runBtn').addEventListener('click', run);
    document.getElementById('resetBtn').addEventListener('click', resetCaps);

    loadAll();
  </script>
</body>
</html>
