<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTrace â€“ Seniority Queue</title>
  <style>
    :root {
      --bg-app: #0b0f16; --bg-card: #121a27; --bg-input: #0d1420;
      --border: rgba(255,255,255,.08); --accent: #2a66ff;
      --text: #e8eefc; --success: #7dff9a; --danger: #ff7d7d;
    }
    body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg-app); color: var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    
    label { display: block; font-size: 11px; font-weight: 700; opacity: .7; text-transform: uppercase; margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.12); background: var(--bg-input); color: white; font-size: 14px; box-sizing: border-box; }
    button { cursor: pointer; background: var(--accent); border: none; font-weight: 800; transition: transform 0.1s; }
    button:active { transform: scale(0.98); }

    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .pill { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 99px; background: rgba(255,255,255,.05); font-size: 12px; margin: 4px; border: 1px solid var(--border); }
    .big { font-size: 20px; font-weight: 800; color: var(--accent); }
    .ok { color: var(--success); }
    .no { color: var(--danger); }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: left; }
    th { background: rgba(255,255,255,.03); font-weight: 600; opacity: .8; }
    
    .error { background: rgba(255, 80, 80, .1); border: 1px solid var(--danger); padding: 12px; border-radius: 8px; margin-top: 15px; display: none; color: var(--danger); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom: 20px;">
        <h1 style="margin:0; font-size:24px;">ProTrace Base Analysis</h1>
        <div style="opacity:0.6; font-size:14px;">In-Line Queue Calculator for Upgrades and Transfers</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row3">
          <div>
            <label>Your Seniority #</label>
            <input id="seniorityInput" type="number" placeholder="Ex: 2670" />
          </div>
          <div>
            <label>Target Base</label>
            <select id="targetBaseSelect"></select>
          </div>
          <div>
            <label>Target Seat</label>
            <select id="targetSeatSelect">
              <option value="CA">Captain (CA)</option>
              <option value="FO">First Officer (FO)</option>
            </select>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
          <div>
            <label>What-If Openings</label>
            <input id="openingsInput" type="number" value="0" />
          </div>
          <div style="display:flex; align-items:end;">
            <button id="runBtn">Run Analysis</button>
          </div>
        </div>
        <div id="errBox" class="error"></div>
      </div>

      <div class="card">
        <div id="resultsHeadline" style="font-size: 16px; line-height: 1.4; font-weight: 600;">Enter your info to see the queue.</div>
        <div style="margin-top:15px; display:flex; flex-wrap:wrap;">
          <div class="pill">Pilot: <b id="pilotName" style="margin-left:5px;">-</b></div>
          <div class="pill">Position in Line: <b id="yourPosition" class="big" style="margin-left:5px;">-</b></div>
          <div class="pill">Projected Status: <b id="clearFlag" style="margin-left:5px;">-</b></div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>Senior Competitors (Pilots bidding Target above Current/Stay)</label>
      <table>
        <thead>
          <tr>
            <th>Sen</th>
            <th>Name</th>
            <th>Current Status</th>
            <th>Bid Rank</th>
            <th>BPL</th>
            <th>Analysis</th>
          </tr>
        </thead>
        <tbody id="competitorsTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
const ROSTER_URL = "./roster.json";
const PREFS_URL  = "./preferences.json";

let cachedRoster = null;
let cachedPrefs = null;

function pick(val) {
  if (!val) return "";
  if (typeof val === 'string') return val.trim();
  if (typeof val === 'object') return val.base || val.code || val.text || "";
  return String(val);
}

async function init() {
  try {
    const [r, p] = await Promise.all([
      fetch(ROSTER_URL).then(res => res.json()),
      fetch(PREFS_URL).then(res => res.json())
    ]);
    cachedRoster = Array.isArray(r) ? r : Object.values(r);
    cachedPrefs = p;

    const bases = [...new Set(cachedRoster.map(p => pick(p.base)))].filter(Boolean).sort();
    document.getElementById("targetBaseSelect").innerHTML = bases.map(b => `<option value="${b}">${b}</option>`).join("");
  } catch (e) {
    const err = document.getElementById("errBox");
    err.style.display = "block";
    err.textContent = "Error: Check your roster.json and preferences.json files.";
  }
}

function run() {
  const senQuery = document.getElementById("seniorityInput").value;
  const tBase = document.getElementById("targetBaseSelect").value;
  const tSeat = document.getElementById("targetSeatSelect").value;
  const tBid = `${tBase} ${tSeat}`;
  const openings = parseInt(document.getElementById("openingsInput").value || 0);

  const user = cachedRoster.find(p => String(p.sen) === senQuery);
  if (!user) { alert("Seniority # not found in roster."); return; }

  const competitors = [];
  const uSen = parseInt(user.sen);

  cachedRoster.forEach(pilot => {
    const pSen = parseInt(pilot.sen);
    if (pSen >= uSen) return; // Skip junior pilots

    const pPrefs = cachedPrefs[`pil${pSen}`] || cachedPrefs[pSen];
    if (!pPrefs || !pPrefs.preferences) return;

    const cBase = pick(pilot.base);
    const cSeat = pick(pilot.seat);
    const currentPos = `${cBase} ${cSeat}`;

    for (const entry of pPrefs.preferences) {
      const bidStr = pick(entry.bid);
      const bidOrder = parseInt(entry.order);

      // 0=1 Stay Logic: If order 1 is empty or current pos, they aren't moving
      if (bidOrder === 1 && (!bidStr || bidStr === "" || bidStr === currentPos)) break;

      // Found a match for target before their current position/stay
      if (bidStr === tBid) {
        if (currentPos !== tBid) { // Don't count if already there
          competitors.push({
            sen: pSen,
            name: pilot.name,
            current: currentPos,
            order: bidOrder,
            bpl: entry.bpl_min || 0
          });
        }
        break; // Counted, stop looking at lower bids
      }

      // If they list their current position, stop looking at lower bids
      if (bidStr === currentPos) break;
    }
  });

  const pos = competitors.length + 1;
  const isClear = openings >= pos;
  const shortBy = Math.max(0, pos - openings);

  document.getElementById("pilotName").textContent = user.name.split(',')[0];
  document.getElementById("yourPosition").textContent = pos;
  document.getElementById("clearFlag").textContent = isClear ? "PROJECTED TO GET" : "BELOW THE LINE";
  document.getElementById("clearFlag").className = isClear ? "ok" : "no";
  
  document.getElementById("resultsHeadline").innerHTML = 
    `Queue: You are #<b>${pos}</b> for ${tBid}.<br>` +
    (isClear ? `<span class="ok">Holdable with current openings.</span>` : `<span class="no">Requires ${shortBy} more openings to clear.</span>`);

  const tbody = document.getElementById("competitorsTableBody");
  tbody.innerHTML = competitors.sort((a,b) => a.sen - b.sen).map(c => `
    <tr>
      <td>${c.sen}</td>
      <td>${c.name}</td>
      <td>${c.current}</td>
      <td>#${c.order}</td>
      <td>${c.bpl}</td>
      <td>Bidding for Upgrade/Transfer</td>
    </tr>
  `).join("");
}

document.getElementById("runBtn").addEventListener("click", run);
init();
</script>
</body>
</html>
