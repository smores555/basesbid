<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Make Roster Match Preferences â€” basesbid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{ --fg:#101828; --muted:#667085; --bg:#f7f9fc; --card:#fff; --line:#e6eaf0; --accent:#2f6df6; --ok:#17a673; --warn:#d98d12; --bad:#cf3a57; }
    *{box-sizing:border-box}
    html,body{margin:0;color:var(--fg);background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    header{
      position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--line);
      padding:12px 16px;display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap
    }
    h1{margin:0;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{border:1px solid var(--line);background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    section.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(16,24,40,.05);margin:16px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
    thead th{position:sticky;top:0;z-index:1;background:#fbfdff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}
    .okbox{padding:10px;border:1px solid #cfe4ff;background:#eef7ff;border-radius:10px;margin-bottom:8px}
    .warnbox{padding:10px;border:1px solid #ffe2a8;background:#fff9ec;border-radius:10px;margin-bottom:8px}
    .badbox{padding:10px;border:1px solid #ffd7dc;background:#fff6f7;border-radius:10px;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    label small{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Make Roster Match Preferences</h1>
      <span class="pill" id="status">Bootingâ€¦</span>
    </div>
    <div class="row">
      <label class="row" style="font-size:12px">
        <input id="chkRename" type="checkbox"> Also replace roster names with preferences names
      </label>
      <button id="btnRun" class="ghost">Reconcile & Generate</button>
      <button id="btnSaveJSON" class="ghost" disabled>Download corrected roster.json</button>
      <button id="btnSaveCSV" class="ghost" disabled>Download diagnostics.csv</button>
    </div>
  </header>

  <section class="card">
    <div class="muted" style="font-size:13px;margin-bottom:8px">
      This tool loads <code>data/roster.json</code> and <code>data/preferences.json</code>, matches pilots by <b>canonical name</b> and overwrites each roster entryâ€™s <code>seniority</code> with the seniority found in preferences for the same name.
      Optionally, it can also replace <code>roster.name</code> with the name string from preferences.
    </div>
    <div id="summary" class="okbox">Waiting to runâ€¦</div>

    <div class="grid">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:14px">Names in roster but not in preferences</h3>
        <div id="missingInPrefs" class="warnbox">â€”</div>
      </div>
      <div>
        <h3 style="margin:0 0 8px 0;font-size:14px">Names in preferences but not in roster</h3>
        <div id="missingInRoster" class="warnbox">â€”</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3 style="margin:0 0 8px 0;font-size:14px">Sample of corrected roster entries</h3>
      <div id="sample"></div>
    </div>
  </section>

  <script>
    const $ = id=>document.getElementById(id);
    const canonRoster = name=>{
      // "First M. Last" -> LAST|FIRST
      const toks=(name||'').replace(/[^A-Za-z,'\.\s-]/g,' ').trim().split(/\s+/);
      if(toks.length<2) return (name||'').toUpperCase();
      const first=toks[0].replace(/\W/g,'').toUpperCase();
      const last=toks[toks.length-1].replace(/\W/g,'').toUpperCase();
      return last+'|'+first;
    };
    const canonPrefs = name=>{
      // "LAST, FIRST M" -> LAST|FIRST
      const s=(name||'').toUpperCase();
      if (s.includes(',')){
        const [last, rest] = s.split(',',2);
        const first = (rest||'').trim().split(/\s+/)[0]||'';
        return last.replace(/\W/g,'')+'|'+first.replace(/\W/g,'');
      }
      return canonRoster(name);
    };
    const esc = s=>`"${String(s??'').replace(/"/g,'""')}"`;

    $('btnRun').addEventListener('click', run);

    async function run(){
      setStatus('Loadingâ€¦');
      try{
        const base = new URL('data/', document.baseURI);
        const [roster, prefs] = await Promise.all([
          fetch(new URL('roster.json', base)).then(r=>{if(!r.ok)throw new Error('roster.json '+r.status); return r.json();}),
          fetch(new URL('preferences.json', base)).then(r=>{if(!r.ok)throw new Error('preferences.json '+r.status); return r.json();}),
        ]);

        // Build maps
        const pmap = new Map(); // nameKey -> {seniority,name}
        prefs.forEach(p=>{
          const k=canonPrefs(p.name||'');
          pmap.set(k, {seniority: Number(p.seniority)||0, name: p.name});
        });

        // Rebuild corrected roster
        let corrected = JSON.parse(JSON.stringify(roster));
        let matched=0, changedSen=0, renamed=0;
        const missingInPrefs=[], missingInRoster=[];

        const rename = $('chkRename').checked;

        const rosterNameKeys = new Set();
        corrected.forEach((r,i)=>{
          const k=canonRoster(r.name||'');
          rosterNameKeys.add(k);
          const hit = pmap.get(k);
          if (hit){
            matched++;
            if ((Number(r.seniority)||0) !== hit.seniority){
              corrected[i].seniority = hit.seniority;
              changedSen++;
            }
            if (rename && (r.name||'') !== (hit.name||'')){
              corrected[i].name = hit.name;
              renamed++;
            }
          } else {
            missingInPrefs.push({name:r.name, seniority:r.seniority});
          }
        });

        // prefs-only names
        pmap.forEach((v,k)=>{ if(!rosterNameKeys.has(k)) missingInRoster.push({name:v.name, seniority:v.seniority}); });

        // Sort by seniority asc for sanity
        corrected.sort((a,b)=>(Number(a.seniority)||0)-(Number(b.seniority)||0));

        $('summary').innerHTML = `<div><b>Matched:</b> ${matched} â€¢ <b>Seniority updated:</b> ${changedSen} â€¢ <b>Renamed:</b> ${renamed}</div>
          <div class="muted" style="margin-top:4px">Roster-only names: ${missingInPrefs.length} â€¢ Prefs-only names: ${missingInRoster.length}</div>`;

        const fmtList = arr => {
          if (!arr.length) return '<span class="muted">None ðŸŽ‰</span>';
          const take = arr.slice(0, 30);
          const rows = take.map(x=>`<div>${esc(x.name)} â€” seniority ${x.seniority}</div>`).join('');
          return rows + (arr.length>take.length? `<div class="muted">â€¦and ${arr.length-take.length} more</div>`: '');
        };
        $('missingInPrefs').innerHTML = fmtList(missingInPrefs);
        $('missingInRoster').innerHTML = fmtList(missingInRoster);

        // sample
        const sample = corrected.slice(0, 20).map(x=>`<tr><td>${x.seniority}</td><td>${x.name}</td><td>${x.currentBase} ${x.currentSeat}</td></tr>`).join('');
        $('sample').innerHTML = `<table><thead><tr><th>Seniority</th><th>Name</th><th>Current</th></tr></thead><tbody>${sample}</tbody></table>`;

        // Enable downloads
        $('btnSaveJSON').disabled=false;
        $('btnSaveCSV').disabled=false;
        $('btnSaveJSON').onclick = ()=>{
          const blob = new Blob([JSON.stringify(corrected, null, 2)], {type:'application/json'});
          const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='roster.json';
          document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
        };
        $('btnSaveCSV').onclick = ()=>{
          const headers=['side','seniority','name'];
          const rows=[]
            .concat(missingInPrefs.map(x=>({side:'roster_only', seniority:x.seniority, name:x.name})))
            .concat(missingInRoster.map(x=>({side:'prefs_only', seniority:x.seniority, name:x.name})));
          const csv=[headers.join(',')].concat(rows.map(r=>[r.side, r.seniority, r.name].map(esc).join(','))).join('\n');
          const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='roster_mismatches.csv';
          document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
        };

        setStatus('Ready â€” review and download corrected files');
      }catch(e){
        setStatus('Error');
        $('summary').innerHTML = `<div class="badbox">Failed: ${e}</div>`;
      }
    }

    function setStatus(t){ $('status').textContent=t; }
  </script>
</body>
</html>
