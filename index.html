<div class="main">
  <div id="cutoffDashboard" class="panel" style="display:none; border:1px solid var(--success); background:rgba(16, 185, 129, 0.05);">
    <div class="panel-title" style="color:var(--success)">Junior-Most Award Cutoffs</div>
    <div id="cutoffList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; font-family:'JetBrains Mono';">
      </div>
  </div>

  <div id="summaryBox" class="status-banner" style="display:none;">
    <div style="font-weight:800; color:var(--accent); margin-bottom:10px;">YOUR HOLD STATUS (SEN: <span id="displaySen"></span>)</div>
    <div id="summaryText" style="line-height: 1.6; font-size:14px;"></div>
  </div>

  <div class="panel-title">System Awards</div>
  <div id="output" class="tab-content" style="background:var(--bg-input); height: 400px; overflow-y: auto;">
    <div id="ledgerBody"></div>
  </div>
</div>

<script>
function runEngine() {
    const userSen = Number(document.getElementById('userSen').value);
    document.getElementById('displaySen').textContent = userSen;
    
    // Reset vacancies from capacities.json
    let vacancies = {};
    capacities.forEach(c => vacancies[`${c.base}__${c.seat}`] = Number(c.delta || 0));

    let cutoffs = {}; // { "SAN__CA": 0, "SAN__FO": 0, ... }
    let moves = [];

    // Sort Roster: Lowest Seniority (1) to Highest (9999)
    const sortedRoster = roster.sort((a, b) => Number(a.sen) - Number(b.sen));

    for (let pilot of sortedRoster) {
        const pSen = Number(pilot.sen);
        // Look up this pilot's bids from preferences.json
        const pPrefs = preferences[pSen]?.preferences || [];

        for (let bid of pPrefs) {
            const key = `${bid.base}__${bid.seat}`;
            
            if (vacancies[key] > 0) {
                vacancies[key]--;
                moves.push({ sen: pSen, name: pilot.name, to: key });
                
                // Update Cutoff: The last person into the seat is the "Junior-Most"
                cutoffs[key] = pSen; 
                break; 
            }
        }
    }
    renderCutoffs(userSen, cutoffs, moves);
}

function renderCutoffs(userSen, cutoffs, moves) {
    const cutoffList = document.getElementById('cutoffList');
    const summaryText = document.getElementById('summaryText');
    
    document.getElementById('cutoffDashboard').style.display = 'block';
    document.getElementById('summaryBox').style.display = 'block';

    // Update the Cutoff Dashboard
    cutoffList.innerHTML = Object.entries(cutoffs).sort().map(([key, sen]) => {
        const [base, seat] = key.split('__');
        return `
            <div style="background:var(--bg-panel); padding:10px; border-radius:6px; border-bottom: 3px solid var(--success);">
                <div style="font-size:10px; color:var(--text-muted);">${base}</div>
                <div style="font-weight:bold;">${seat}</div>
                <div style="font-size:18px; color:var(--success);">${sen}</div>
            </div>`;
    }).join('');

    // Update Your Gap Summary
    // We check Choice #1 through #3 specifically
    let html = "";
    [1, 2, 3].forEach(i => {
        const b = document.getElementById(`p${i}-base`).value;
        const s = document.getElementById(`p${i}-seat`).value;
        const key = `${b}__${s}`;
        const cutoff = cutoffs[key] || 0;

        if (cutoff > 0 && userSen <= cutoff) {
            html += `<div>Choice #${i} (${b} ${s}): <b style="color:var(--success)">HOLDING</b></div>`;
        } else {
            const gap = cutoff === 0 ? "No Vacancies" : `${userSen - cutoff} numbers away`;
            html += `<div>Choice #${i} (${b} ${s}): <b style="color:var(--danger)">${gap}</b></div>`;
        }
    });
    summaryText.innerHTML = html;
}
</script>
