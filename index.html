<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUILD‑V11.1 — Perf hardened: batched ledger + guarded cascade</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8aa4c1; --text:#eaf2ff; --accent:#8ad2ff; --border:#1f2a44; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1240px;margin:18px auto;padding:0 12px 42px}
    .banner{background:#123361;border-bottom:3px solid #8ad2ff;color:#fff;padding:10px 12px;font-weight:800;border-radius:0 0 12px 12px;letter-spacing:.3px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0}
    button{background:#2e4a78;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.secondary{background:#203453}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    td{background:#0f182a;border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
    .grid{display:grid;gap:12px;grid-template-columns: 1fr 1fr 1fr}
    .kv{display:flex;align-items:center;justify-content:space-between;background:#0f182a;border:1px solid var(--border);padding:6px 8px;border-radius:10px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .subtle{color:#8aa4c1}
  </style>
</head>
<body>
  <div class="banner">BUILD‑V11.1 — Perf hardened: batched ledger + guarded cascade</div>
  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <button id="runBtn">Run Simulation</button>
        <button class="secondary" id="resetBtn">Reset</button>
        <label class="subtle mono"><input type="checkbox" id="muteLedger" /> Mute ledger (faster)</label>
        <label class="subtle mono" style="margin-left:8px"><input type="checkbox" id="muteOpen" /> Mute open box (faster)</label>
      </div>
      <div id="summary" class="subtle mono"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Open Vacancies</h3>
        <div id="openVac"></div>
      </div>
      <div class="card">
        <h3>Vacancy Ledger</h3>
        <div style="max-height:260px;overflow:auto">
          <table style="width:100%">
            <thead>
              <tr class="subtle">
                <th>Pass</th><th>Action</th><th>Pilot</th><th>From</th><th>To</th>
              </tr>
            </thead>
            <tbody id="ledgerBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h3>Moves</h3>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    // Minimal mock to illustrate perf hardening; wire your real data
    const BASES = ["SEA","ANC","PDX","SFO","LAX"];
    const SEATS = ["CA","FO"];
    const Open = new Map(); // "BASE__SEAT" -> count
    const bkey = (b,s)=>`${b}__${s}`;

    const state = {
      running:false,
      maxPass: 2000,        // hard stop
      maxMoves: 20000,      // guard rail
      pass: 0,
      moves: []
    };

    const $summary = document.getElementById('summary');
    const $ledgerBody = document.getElementById('ledgerBody');
    const $openVac = document.getElementById('openVac');
    const muteLedger = ()=> document.getElementById('muteLedger').checked;
    const muteOpen   = ()=> document.getElementById('muteOpen').checked;

    function renderOpenBatched(batch){
      if (muteOpen()) return;
      // batch is a Map key->delta accumulated this pass
      for (const [k, delta] of batch.entries()){
        Open.set(k, (Open.get(k)||0) + delta);
      }
      const entries = [...Open.entries()].filter(([,v])=>v!==0).sort((a,b)=>a[0].localeCompare(b[0]));
      $openVac.innerHTML = entries.map(([k,v])=>{
        const [b,s] = k.split('__'); const sign = v>0?'+':'';
        return `<div class="kv"><span>${b} ${s}</span><span class="mono">${sign}${v}</span></div>`;
      }).join('') || '<div class="subtle">No open vacancies</div>';
    }

    function renderLedgerBatched(rows){
      if (muteLedger()) return;
      if (!rows.length) return;
      const frag = document.createDocumentFragment();
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="mono">${r.pass}</td><td>${r.action}</td><td>${r.pilot}</td><td>${r.from}</td><td>${r.to}</td>`;
        frag.appendChild(tr);
      }
      $ledgerBody.appendChild(frag);
    }

    function summarize(){
      $summary.textContent = `pass=${state.pass} moves=${state.moves.length} open=${[...Open.values()].reduce((a,b)=>a+b,0)}`;
    }

    // --- Demo engine (replace with the real one) ---
    function run(){
      if (state.running) return;
      state.running = true;
      state.pass = 0;
      state.moves = [];
      Open.clear();
      $ledgerBody.innerHTML = '';
      $openVac.innerHTML = '';

      // Seed: pretend +10 SEA CA, +4 ANC CA, +6 PDX CA
      Open.set(bkey("SEA","CA"), 10);
      Open.set(bkey("ANC","CA"), 4);
      Open.set(bkey("PDX","CA"), 6);
      summarize();

      // Simulate passes asynchronously to keep UI responsive
      function onePass(){
        if (state.pass >= state.maxPass) { state.running=false; summarize(); return; }
        state.pass++;

        const ledgerBatch = [];
        const openBatch = new Map();

        // fake 50 moves per pass until vacancies dry up
        let madeMove = false;
        for (let i=0; i<50; i++){
          // find any open to fill
          const openList = [...Open.entries()].filter(([,v])=>v>0);
          if (!openList.length) break;
          const [k] = openList[Math.floor(Math.random()*openList.length)];
          // fill that vacancy and create a FO hole randomly
          const [b,s] = k.split('__');
          openBatch.set(k, (openBatch.get(k)||0) - 1); // FILLED
          const from = b + " " + (s==="CA"?"FO":"CA"); // demo
          const srcKey = bkey(b, s==="CA"?"FO":"CA");
          openBatch.set(srcKey, (openBatch.get(srcKey)||0) + 1); // CREATED
          ledgerBatch.push({ pass: state.pass, action:"FILLED", pilot:`SEN ${100+Math.floor(Math.random()*900)}`, from:"", to:`${b} ${s}` });
          ledgerBatch.push({ pass: state.pass, action:"CREATED", pilot:`SEN ${100+Math.floor(Math.random()*900)}`, from:from, to:"" });
          state.moves.push(1);
          madeMove = true;
          if (state.moves.length >= state.maxMoves) break;
        }

        renderOpenBatched(openBatch);
        renderLedgerBatched(ledgerBatch);
        summarize();

        if (madeMove && state.moves.length < state.maxMoves) {
          // yield to UI then do another pass
          setTimeout(onePass, 0);
        } else {
          state.running = false;
          summarize();
        }
      }

      onePass();
    }

    document.getElementById('runBtn').addEventListener('click', run);
    document.getElementById('resetBtn').addEventListener('click', ()=>{ Open.clear(); $openVac.innerHTML=''; $ledgerBody.innerHTML=''; state.moves=[]; state.pass=0; summarize(); });
  </script>
</body>
</html>
