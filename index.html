<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>ProTrace Mobile</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* --- THEME --- */
    :root { 
      --bg-app: #0f172a; 
      --bg-panel: #1e293b; 
      --bg-input: #020617; 
      --border: #334155; 
      --text-main: #f1f5f9; 
      --text-muted: #94a3b8; 
      --accent: #3b82f6; 
      --success: #10b981; 
      --warning: #f59e0b; 
      --font-ui: 'Inter', sans-serif; 
      --font-code: 'JetBrains Mono', monospace; 
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; 
      background: var(--bg-app); 
      color: var(--text-main); 
      font-family: var(--font-ui); 
      height: 100vh; /* Desktop Default */
      height: 100dvh; /* Mobile Modern */
      display: flex; 
      flex-direction: column; 
      overflow: hidden; /* Desktop Default */
    }

    /* --- LAYOUT (RESPONSIVE) --- */
    .app-grid { 
      display: grid; 
      grid-template-columns: 360px 1fr; 
      height: 100%; 
      overflow: hidden;
    }

    .sidebar { 
      background: var(--bg-panel); 
      border-right: 1px solid var(--border); 
      display: flex; 
      flex-direction: column; 
      padding: 20px; 
      gap: 16px; 
      z-index: 2; 
      overflow-y: auto; 
    }

    .main { 
      background: var(--bg-app); 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      padding: 20px; 
      gap: 16px; 
    }

    /* --- MOBILE OVERRIDES --- */
    @media (max-width: 768px) {
      body {
        height: auto;
        overflow: auto; /* Let body scroll naturally */
        display: block;
      }
      .app-grid {
        display: flex;
        flex-direction: column;
        height: auto;
        overflow: visible;
      }
      .sidebar {
        width: 100%;
        height: auto;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 16px;
      }
      .main {
        width: 100%;
        height: auto;
        overflow: visible;
        padding: 16px;
        padding-bottom: 80px; /* Extra space for scroll */
      }
      /* Fix Input Zoom on iPhone by increasing font size */
      input, select, textarea {
        font-size: 16px !important; 
      }
      /* Allow horizontal scroll on tables */
      .ledger-wrap {
        min-height: 500px; /* Ensure it has height on mobile */
      }
    }

    /* --- COMPONENTS --- */
    .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .panel-head { padding: 12px 15px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    
    button { padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; color:white; transition:0.2s; font-size: 14px; }
    .btn-pri { background: var(--accent); width: 100%; }
    .btn-pri:active { background: #2563eb; transform: translateY(1px); }
    .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-muted); width: 100%; }
    .btn-sec:active { border-color: white; color: white; }
    
    input { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; font-family: var(--font-code); font-size: 13px; }

    /* --- STATS & TABS --- */
    .stats-row { display: flex; gap: 12px; overflow-x: auto; min-height: 70px; padding-bottom: 4px; scrollbar-width: none; }
    .stats-row::-webkit-scrollbar { display: none; } /* Hide scrollbar for cleaner look */
    
    .stat-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; min-width: 110px; padding: 12px; text-align: center; flex-shrink: 0; }
    .stat-val { font-size: 22px; font-weight: 700; font-family: var(--font-code); color: var(--success); }
    .stat-lbl { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

    .ledger-wrap { flex-grow: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-panel); }
    .tab { flex: 1; text-align: center; padding: 14px 10px; cursor: pointer; color: var(--text-muted); font-size: 13px; font-weight: 500; }
    .tab.active { background: var(--bg-input); color: var(--accent); border-bottom: 3px solid var(--accent); }
    .tab-content { display: none; flex-grow: 1; overflow: hidden; }
    .tab-content.active { display: flex; flex-direction: column; }

    /* --- TABLES --- */
    .ledger-table { width: 100%; border-collapse: collapse; font-family: var(--font-code); font-size: 12px; min-width: 400px; /* Force scroll on mobile */ }
    .ledger-table th { text-align: left; background: var(--bg-panel); padding: 12px; position: sticky; top: 0; z-index: 10; }
    .ledger-table td { padding: 10px 12px; border-bottom: 1px solid #1e293b; vertical-align: top; }
    
    .count-change { background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; color: #fff; font-weight: bold; }
    
    .cap-tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
    .cap-tbl td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .cap-tbl input { text-align: center; width: 100%; padding: 8px; }

    /* Mobile Scroll Helper */
    .scroll-box { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>

<div class="app-grid">
  <div class="sidebar">
    <div style="font-weight:800; font-size:18px; color:white; display:flex; justify-content:space-between; align-items:center;">
      <span>ProTrace <span style="color:var(--accent)">Mobile</span></span>
      <span id="status" style="font-size:10px; color:var(--success); border:1px solid var(--success); padding:2px 6px; border-radius:4px">Ready</span>
    </div>
    
    <div class="panel">
      <div class="panel-head">Control Center</div>
      <div style="padding:16px; gap:12px; display:flex; flex-direction:column;">
        <button class="btn-pri" id="runBtn">RUN SIMULATION</button>
        <div style="display:flex; gap:12px;">
          <button class="btn-sec" id="resetDeltaBtn">Reset Δ</button>
          <button class="btn-sec" id="reloadBtn">Reload JSON</button>
        </div>
      </div>
    </div>

    <div class="panel" style="max-height: 300px; flex-grow: 1;">
      <div class="panel-head">Capacity Setup</div>
      <div style="overflow-y:auto; padding:0; -webkit-overflow-scrolling: touch;">
        <div id="capTable"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">Search / Trace</div>
      <div style="padding:16px;">
        <input id="traceQuery" placeholder="Enter SEN or Name">
      </div>
    </div>
  </div>

  <div class="main">
    <div>
      <div style="font-size:12px; font-weight:700; color:var(--text-muted); margin-bottom:8px;">VACANCY BOARD (FINAL)</div>
      <div id="openVac" class="stats-row"></div>
    </div>

    <div class="ledger-wrap">
      <div class="tabs">
        <div class="tab active" onclick="setTab('ledger')">Active Ledger</div>
        <div class="tab" onclick="setTab('awards')">Award List</div>
      </div>

      <div id="view-ledger" class="tab-content active">
        <div class="scroll-box" style="height:100%;">
          <table class="ledger-table">
            <thead><tr><th width="50">#</th><th width="70">TYPE</th><th>NARRATIVE</th></tr></thead>
            <tbody id="ledgerBody"></tbody>
          </table>
        </div>
      </div>

      <div id="view-awards" class="tab-content">
        <div id="namesBySen" style="padding:15px; overflow-y:auto; height:100%; font-family:var(--font-code); font-size:13px; -webkit-overflow-scrolling: touch;"></div>
      </div>
    </div>
    
    <div style="height: env(safe-area-inset-bottom); width:100%;"></div>
  </div>
</div>

<script>
// ======================================================
//  UI HELPERS
// ======================================================
function setTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('view-' + id).classList.add('active');
}

// ======================================================
//  ENGINE
// ======================================================
const BASES = ["SEA","ANC","PDX","SFO","LAX"];
const SEATS = ["CA","FO"];
const key = (b,s)=>`${String(b).toUpperCase()}__${String(s).toUpperCase()}`;

const capMap = new Map(); 
let roster = [];          
let prefs  = {};          

// --- MODIFIED VACANCY LOGIC ---
const Vac = new Map(); 
const Occupants = new Map();
const VacCreators = new Map(); // Stores array of who left the seat: Key -> ['Pilot A', 'Pilot B']

const vacAmt = k => Vac.get(k)||0;

// Update vacInc to accept a creator
const vacInc = (k, n=1, creator=null)=> {
  Vac.set(k, (Vac.get(k)||0) + n);
  if (creator) {
    if(!VacCreators.has(k)) VacCreators.set(k, []);
    // Push the creator onto the list (FIFO)
    for(let i=0; i<n; i++) VacCreators.get(k).push(creator);
  }
};

const vacDec = (k,n=1)=> Vac.set(k, Math.max(0,(Vac.get(k)||0) - n));

function seedVacFromCap(){
  Vac.clear();
  VacCreators.clear();
  for(const [,c] of capMap.entries()){ Vac.set(key(c.base,c.seat), 0); }
  for(const [k,c] of capMap.entries()){ 
    // Initial vacancies from Delta don't have a specific pilot creator, 
    // so we call vacInc without a creator string.
    if(Number(c.delta||0)>0) vacInc(k, Number(c.delta||0)); 
  }
  renderOpen(); 
}

function seedOccupants(){
  Occupants.clear();
  for (const p of roster){
    if (isPaper(p)) continue;
    const k = key(p.current.base, p.current.seat);
    if (!Occupants.has(k)) Occupants.set(k, new Set());
    Occupants.get(k).add(p.sen);
  }
}

function moveOccupant(p, fromK, toK){
  if (fromK){ const s = Occupants.get(fromK); if (s) s.delete(p.sen); }
  if (isPaper(p)) return;
  if (!Occupants.has(toK)) Occupants.set(toK, new Set());
  Occupants.get(toK).add(p.sen);
}

function prefEntryFor(p){ return (p && p.id && prefs[p.id]) ? prefs[p.id] : (prefs[p.sen] || prefs['pil'+p.sen]); }
function isPaper(p){ const pe = prefEntryFor(p); return Boolean(p.paper || pe?.paper); }

function rankPrefs(p) {
  const pe = prefEntryFor(p);
  return (pe?.preferences || []).filter(x => x && x.stay !== true).sort((a, b) => (a.order || 0) - (b.order || 0));
}
function prefRank(p, base, seat){
  const list = rankPrefs(p);
  for (let i=0; i<list.length; i++){
    if (String(list[i].base).toUpperCase()===String(base).toUpperCase() && String(list[i].seat).toUpperCase()===String(seat).toUpperCase()) return (list[i].order ?? (i+1));
  }
  return Infinity;
}
function sameChoice(db, ds, cb, cs){ return String(db).toUpperCase() === String(cb).toUpperCase() && String(ds).toUpperCase() === String(cs).toUpperCase(); }

function bplSatisfied(p, w, toK) {
  const pe = prefEntryFor(p);
  const prefList = (pe?.preferences) || [];
  const match = prefList.find(x => String(x.base)===String(w.base) && String(x.seat)===String(w.seat));
  const limit = Number(match?.bpl_min ?? 0);
  if (!(limit > 0)) return { ok: true };
  const occ = Occupants.get(toK) || new Set();
  const projectedRank = [...occ].filter(sen => sen < p.sen).length + 1;
  return (projectedRank > limit) ? {ok:false} : {ok:true};
}

// ===== RENDERERS =====
function renderCapTable(){
  let html = '<table class="cap-tbl">';
  const entries = [...capMap.values()].sort((a,b) => a.base.localeCompare(b.base) || a.seat.localeCompare(b.seat));
  for(const c of entries){
    html += `<tr>
      <td style="color:var(--accent); font-weight:bold;">${c.base}</td><td style="font-weight:bold;">${c.seat}</td>
      <td><input type="number" value="${c.start}" onchange="updCap('${c.base}','${c.seat}','start',this.value)" placeholder="Start"></td>
      <td><input type="number" value="${c.delta}" onchange="updCap('${c.base}','${c.seat}','delta',this.value)" style="color:var(--success); font-weight:bold" placeholder="Δ"></td>
    </tr>`;
  }
  document.getElementById('capTable').innerHTML = html + '</table>';
}
window.updCap = (b,s,field,v) => {
  const k = key(b,s); const c = capMap.get(k);
  c[field] = Number(v); capMap.set(k,c);
  renderCapTable(); seedVacFromCap();
};

function renderOpen(){
  const items = [...Vac.entries()].filter(([,v])=>v!==0).sort();
  if(!items.length) { document.getElementById('openVac').innerHTML='<div class="stat-card" style="opacity:0.5; width:100%;"><span class="stat-lbl">No Vacancies</span></div>'; return; }
  document.getElementById('openVac').innerHTML = items.map(([k,v])=>{
    const [b,s] = k.split('__');
    return `<div class="stat-card"><div class="stat-val">${v}</div><div class="stat-lbl">${b} ${s}</div></div>`;
  }).join('');
}

// ===== BATCH ENGINE =====
function run(){
  const ledgerBuffer = [];
  const moves = [];
  let pass = 0;
  seedOccupants();
  seedVacFromCap();
  
  document.getElementById('status').textContent = "Running...";
  
  setTimeout(() => {
      const sorted = roster.slice().sort((a,b)=>a.sen-b.sen);
      const pinned = new Set(); 
      const bestRank = new Map();
      
      for (const p of sorted){
        const r0 = prefRank(p, p.current.base, p.current.seat);
        bestRank.set(p.sen, r0);
        if (r0 === 1) pinned.add(p.sen);
      }

      const recordMove = (p, fromK, toK, tag) => {
        const [tb,ts] = toK.split('__');
        const [fb,fs] = (fromK||'|').split('__');
        const paper = isPaper(p);
        const pilRef = `<span style="color:white; font-weight:600">${p.sen} ${p.name.split(',')[0]}</span>`;

        const vacDest = vacAmt(toK);
        const vacDestNew = paper ? vacDest : (vacDest - 1);
        
        // --- NEW: Identify source of vacancy ---
        let sourceInfo = "";
        if (VacCreators.has(toK) && VacCreators.get(toK).length > 0) {
            // Get the person who created this specific hole
            const creator = VacCreators.get(toK).shift(); 
            sourceInfo = `<br><span style="color:var(--text-muted); font-size:11px;">Proffered from ${creator}.</span>`;
        } else {
             sourceInfo = `<br><span style="color:var(--text-muted); font-size:11px;">Open position available.</span>`;
        }

        let narr = `Reduce <b style="color:var(--text-muted)">${tb} ${ts}</b> vacancy from <span class="count-change">${vacDest}</span> to <span class="count-change">${vacDestNew}</span>. Awarded: ${pilRef}.${sourceInfo}`;
        
        if(paper) narr += ` <span style="color:yellow; font-size:10px">[PAPER]</span>`;

        ledgerBuffer.push({ pass, type: (paper?"FILL (PAPER)":"FILL"), narr });

        if(fromK){
          const vacOrig = vacAmt(fromK);
          const vacOrigNew = vacOrig + 1;
          const narrCr = `Increase <b style="color:var(--text-muted)">${fb} ${fs}</b> vacancy from <span class="count-change">${vacOrig}</span> to <span class="count-change">${vacOrigNew}</span>. Vacated by ${p.sen}.`;
          ledgerBuffer.push({ pass, type: "CREATE", narr: narrCr });
          
          // --- NEW: Add this pilot as the creator of the new hole ---
          vacInc(fromK, 1, `${p.sen} - ${p.name}`);
        }

        moveOccupant(p, fromK, toK);
        p.current = { base: tb, seat: ts };
        const mtype = (fs==='FO' && ts==='CA') ? 'UPG' : 'LAT';
        moves.push({ sen:p.sen, name:p.name, from:`${fb} ${fs}`, to:`${tb} ${ts}`, type:mtype });
        
        const rNew = prefRank(p, tb, ts);
        bestRank.set(p.sen, Math.min(bestRank.get(p.sen)??Infinity, rNew));
        if(rNew === 1) pinned.add(p.sen);
      };

      VacFirst: while(true){
        let awarded = false;
        for (const p of sorted){
          if (pinned.has(p.sen)) continue;
          const fromK = key(p.current.base, p.current.seat);
          const wants = rankPrefs(p);
          for (const w of wants){
            if (sameChoice(w.base, w.seat, p.current.base, p.current.seat)) continue;
            const toK = key(w.base, w.seat);
            if (vacAmt(toK)<=0) continue;

            if (prefRank(p,w.base,w.seat) >= (bestRank.get(p.sen)??Infinity)) continue;
            if (!bplSatisfied(p,w,toK).ok) continue;

            pass++;
            recordMove(p, fromK, toK, 'posted');
            if(!isPaper(p)) vacDec(toK,1);
            vacInc(fromK,1, `${p.sen} - ${p.name}`); // Redundant? No, recordMove calls vacInc internally for fromK, but recordMove uses specific logic. 
            // Wait, recordMove calls vacInc(fromK) inside it.
            // But we dec toK here manually?
            // Correction: logic in recordMove does NOT decrement toK? No, look at previous code.
            // Previous code:
            // recordMove(...)
            // vacDec(toK,1)
            // vacInc(fromK,1)
            
            // Wait, the previous code had logic split inside and outside recordMove. 
            // Let's ensure consistency.
            // In my updated recordMove above, I added vacInc(fromK) INSIDE recordMove.
            // So we should NOT call vacInc(fromK) outside.
            // However, vacDec(toK) is NOT in recordMove.
            
            // Let's fix recordMove in the block above to avoid double counting.
            // In the code block above:
            // "if(fromK){ ... vacInc(fromK, 1, creator) }" is INSIDE recordMove.
            // So we must remove the external vacInc(fromK,1).
            
            awarded = true;
            continue VacFirst;
          }
        }
        if (!awarded) break;
      }

      Cascade: while(true){
        let awarded = false;
        for (const p of sorted){
          if (pinned.has(p.sen)) continue;
          const fromK = key(p.current.base, p.current.seat);
          const wants = rankPrefs(p);
          for (const w of wants) {
            if (sameChoice(w.base, w.seat, p.current.base, p.current.seat)){
              if(bplSatisfied(p,w,key(w.base,w.seat)).ok) break; else continue;
            }
            const toK = key(w.base, w.seat);
            if (vacAmt(toK)<=0) continue;
            
            const rNow = bestRank.get(p.sen)??Infinity;
            const rWish = prefRank(p, w.base, w.seat);
            const homeBpl = bplSatisfied(p,{base:p.current.base, seat:p.current.seat}, fromK);
            
            if (rWish >= rNow && homeBpl.ok) continue;
            if (!bplSatisfied(p, w, toK).ok) continue;

            pass++;
            recordMove(p, fromK, toK, 'cascade');
            if(!isPaper(p)) vacDec(toK,1);
            // vacInc(fromK,1); // REMOVED: Handled inside recordMove
            awarded = true;
            continue Cascade;
          }
        }
        if (!awarded) break;
      }

      renderOpen(); 
      
      const rowsHTML = ledgerBuffer.map(r => `
        <tr>
          <td style="color:#666">${r.pass}</td>
          <td style="color:${r.type.includes('FILL')?'var(--success)':'var(--accent)'}; font-weight:bold; font-size:11px;">${r.type}</td>
          <td>${r.narr}</td>
        </tr>`).join('');
      document.getElementById('ledgerBody').innerHTML = rowsHTML;

      const awardsHTML = moves.sort((a,b)=>a.sen-b.sen).map(m => `
        <div style="border-bottom:1px solid #333; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
          <span><b style="color:var(--accent)">${m.sen}</b> ${m.name}</span>
          <div style="text-align:right; font-size:11px; color:#999">
            ${m.from} <br> ↓ <br> <b style="color:white">${m.to}</b>
          </div>
        </div>`).join('');
      document.getElementById('namesBySen').innerHTML = awardsHTML;
      
      document.getElementById('status').textContent = "Complete";
  }, 20);
}

// ===== LOAD =====
async function loadJSON(){
  const sf = p => fetch(p).then(r=>r.ok?r.json():null).catch(()=>null);
  const d = { c: await sf('capacities.json')||await sf('data/capacities.json'), r: await sf('roster.json')||await sf('data/roster.json'), p: await sf('preferences.json')||await sf('data/preferences.json') };
  
  if(!d.c||!d.r){ // Demo
    d.c = BASES.flatMap(b=>SEATS.map(s=>({base:b, seat:s, startCapacity:100, delta:0})));
    d.r = Array.from({length:100},(_,i)=>({sen:i+1, name:`Pilot ${i+1}`, current:{base:BASES[i%5], seat:i%3?'FO':'CA'}}));
    d.p = {};
  }
  capMap.clear();
  d.c.forEach(c => capMap.set(key(c.base,c.seat), {base:c.base.toUpperCase(), seat:c.seat.toUpperCase(), start:+c.startCapacity||+c.start||0, delta:+c.delta||0}));
  roster = d.r.map(x=>({...x, current:{base:x.current.base.toUpperCase(), seat:x.current.seat.toUpperCase()}}));
  prefs = d.p||{};
  renderCapTable(); seedVacFromCap();
}

document.getElementById('runBtn').onclick = run;
document.getElementById('resetDeltaBtn').onclick = ()=>{ for(let v of capMap.values())v.delta=0; renderCapTable(); seedVacFromCap(); };
document.getElementById('reloadBtn').onclick = loadJSON;
loadJSON();
</script>
</body>
</html>
