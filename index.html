<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Frozen-Bid Vacancy Cascade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --fg:#0b1320; --muted:#6a7487; --bg:#f6f8fb; --card:#fff; --line:#e6ebf2; --accent:#2b5be9; }
    *{box-sizing:border-box}
    html,body{margin:0;color:var(--fg);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;max-width:1400px;margin:16px auto;padding:0 16px}
    section.card,aside{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(10,20,40,.05)}
    aside{padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="file"],input[type="number"],input[type="text"],select{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
    button{border:1px solid var(--line);background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
    th{background:#fafbfe;position:sticky;top:0;z-index:1}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
    .capTable{max-height:60vh;overflow:auto}
    .resultsHeader{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .empty{padding:24px;color:#6a7487;text-align:center}
    @media (max-width:1024px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Frozen-Bid Vacancy Cascade</h1>
      <span class="badge" id="status">Booting…</span>
    </div>
    <div class="row">
      <button class="ghost" id="btnFetch">Load /data/*.json</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;">
        capacities.json <input type="file" id="fCap" accept=".json">
      </label>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;">
        roster.json <input type="file" id="fRos" accept=".json">
      </label>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:6px;">
        preferences.json <input type="file" id="fPref" accept=".json">
      </label>
      <button id="btnRun">Run Cascade</button>
      <button class="ghost" id="btnCSV" disabled>Download CSV</button>
    </div>
  </header>

  <main>
    <aside>
      <h3 style="margin:4px 0 10px;">Capacities</h3>
      <div class="row" style="margin-bottom:8px;">
        <select id="qdbBase"><option>ANC</option><option>LAX</option><option>PDX</option><option>SEA</option><option>SFO</option></select>
        <select id="qdbSeat"><option>CA</option><option>FO</option></select>
        <input id="qdbAmt" type="number" value="10" style="width:90px">
        <button class="ghost" id="qdbApply">Apply Δ</button>
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:8px;"><input type="checkbox" id="autoRun"> Auto-run</label>
      </div>
      <div class="capTable" id="capTable"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px;">
        <div class="row">
          <span class="muted">Nudge all:</span>
          <button class="ghost" data-nudge="+1">+1</button>
          <button class="ghost" data-nudge="+5">+5</button>
          <button class="ghost" data-nudge="+10">+10</button>
          <button class="ghost" data-nudge="-1">−1</button>
          <button class="ghost" data-nudge="-5">−5</button>
          <button class="ghost" data-nudge="-10">−10</button>
        </div>
        <button class="ghost" id="btnResetDelta">Reset Deltas</button>
      </div>
    </aside>

    <section class="card">
      <div class="resultsHeader">
        <div class="filters">
          <strong>Awards</strong>
          <input id="q" type="text" placeholder="Search name or seniority…" style="width:220px">
          <select id="fltMove">
            <option value="all">All awards</option>
            <option value="movers">Movers only</option>
            <option value="upgrades">Upgrades only</option>
          </select>
          <select id="fltBase"><option value="">Any awarded base</option></select>
          <select id="fltSeat"><option value="">Any awarded seat</option><option>CA</option><option>FO</option></select>
          <button class="ghost" id="btnClear">Clear</button>
        </div>
        <div class="muted" id="summary">No run yet</div>
      </div>
      <div id="resultsTable" style="max-height:70vh;overflow:auto">
        <div class="empty">Waiting for data…</div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Utilities ----------
    const key = (b,s)=> String(b).toUpperCase()+'|'+String(s).toUpperCase();
    const parsePref = (p) => {
      if (p===null || p===undefined) return null;
      const t = String(p).trim().toUpperCase();
      if (!t) return null;
      if (t === '0') return {base:null, seat:null, stay:true};
      const parts = t.replace(/\\s*[-/]\\s*/g,' ').split(/\\s+/);
      if (parts.length >= 2) return {base:parts[0], seat:parts[1], stay:false};
      return null;
    };
    const el = (tag, attrs={}, ...kids) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if (k==='class') n.className=v; else if (k==='html') n.innerHTML=v;
        else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      });
      kids.flat().forEach(k => n.appendChild(typeof k==='string'? document.createTextNode(k) : k));
      return n;
    };
    const escCSV = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const toCSV = (rows, headers) => [headers.join(','), ...rows.map(r => headers.map(h => escCSV(r[h])).join(','))].join('\\n');
    const $ = (id)=> document.getElementById(id);

    // ---------- State ----------
    let capacities=[], roster=[], prefs=[], results=[];

    // ---------- Auto-load on open ----------
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await fetchDefault();
        $('btnFetch').style.display = 'none';
      } catch (e) {
        $('status').textContent = 'Auto-load failed';
        console.warn(e);
        // Keep pickers visible; show quick tip in results area
        $('resultsTable').innerHTML = '<div class="empty">Could not auto-load /data/*.json. Use the file pickers above, or check that <code>data/capacities.json</code>, <code>data/roster.json</code>, and <code>data/preferences.json</code> exist in your repo.</div>';
      }
    });

    // ---------- Loaders ----------
    async function fetchDefault(){
      const basePath = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/\\/[^/]*$/, '/');
      const prefix = basePath + 'data/';
      const tryFetch = async (url) => {
        const r = await fetch(url);
        if (!r.ok) throw new Error(url + ' → ' + r.status);
        return r.json();
      };
      [capacities, roster, prefs] = await Promise.all([
        tryFetch(prefix+'capacities.json'),
        tryFetch(prefix+'roster.json'),
        tryFetch(prefix+'preferences.json'),
      ]);
      normalizeState();
      $('status').textContent = `Loaded /data  •  ${roster.length} pilots`;
    }

    async function readLocalJSON(file){ return JSON.parse(await file.text()); }

    // ---------- Normalize ----------
    function normalizeState(){
      capacities = capacities.map(r=>({ base:String(r.base).toUpperCase().trim(), seat:String(r.seat).toUpperCase().trim(), startCapacity:Number(r.startCapacity)||0, delta:Number(r.delta)||0 }));
      roster = roster.map(r=>({ seniority:Number(r.seniority)||0, name:String(r.name||''), currentBase:String(r.currentBase||'').toUpperCase().trim(), currentSeat:String(r.currentSeat||'').toUpperCase().trim() })).filter(r=>r.seniority>0).sort((a,b)=>a.seniority-b.seniority);
      renderCapacities();
      const bases=[...new Set(capacities.map(r=>r.base))].sort(); $('fltBase').innerHTML='<option value=\"\">Any awarded base</option>'+bases.map(b=>`<option>${b}</option>`).join('');
      results=[]; renderResults();
    }

    // ---------- Capacity UI ----------
    function renderCapacities(){
      const holder=$('capTable'); holder.innerHTML='';
      const by = new Map(); capacities.forEach(r=>{ if(!by.has(r.base)) by.set(r.base,[]); by.get(r.base).push(r); });
      for (const base of Array.from(by.keys()).sort()){
        const rows = by.get(base).sort((a,b)=>a.seat.localeCompare(b.seat));
        const tbl = el('table'), thead = el('thead',{}, el('tr',{}, el('th',{}, base), el('th',{}, 'Seat'), el('th',{}, 'Start'), el('th',{}, 'Delta'), el('th',{}, 'Total'))), tbody = el('tbody');
        rows.forEach(r=>{
          const tr = el('tr',{},
            el('td',{}, base),
            el('td',{}, r.seat),
            el('td',{}, String(r.startCapacity)),
            el('td',{}, el('div',{class:'row'},
              el('button',{class:'ghost', onclick:()=>{ r.delta--; upd(); }}, '–'),
              el('input',{type:'number', value:r.delta, style:'width:80px', oninput:e=>{ r.delta=Number(e.target.value)||0; upd(); }}),
              el('button',{class:'ghost', onclick:()=>{ r.delta++; upd(); }}, '+')
            )),
            el('td',{}, el('span',{class:'pill'}, String(r.startCapacity + r.delta)))
          );
          function upd(){ tr.lastChild.firstChild.textContent = String(r.startCapacity + r.delta); if ($('autoRun').checked) runCascade(); }
          tbody.appendChild(tr);
        });
        tbl.appendChild(thead); tbl.appendChild(tbody); holder.appendChild(tbl);
      }
    }

    // Quick delta bar
    $('qdbApply').addEventListener('click', ()=>{
      const b=$('qdbBase').value, s=$('qdbSeat').value, amt=Number($('qdbAmt').value)||0;
      let changed=false; capacities.forEach(r=>{ if(r.base===b && r.seat===s){ r.delta=(r.delta||0)+amt; changed=true; }});
      if (changed){ renderCapacities(); if ($('autoRun').checked) runCascade(); }
    });
    // Nudge all
    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('button[data-nudge]'); if(!btn) return;
      const n=Number(btn.getAttribute('data-nudge')); capacities.forEach(r=> r.delta=(r.delta||0)+n );
      renderCapacities(); if ($('autoRun').checked) runCascade();
    });
    $('btnResetDelta').addEventListener('click', ()=>{ capacities.forEach(r=> r.delta=0); renderCapacities(); if ($('autoRun').checked) runCascade(); });

    // ---------- Cascade ----------
    function runCascade(){
      if (!capacities.length || !roster.length){
        alert('Load capacities and roster first (from /data or via file pickers).');
        return;
      }
      const capMap=new Map(); capacities.forEach(r=> capMap.set(key(r.base,r.seat), {cap:Math.max(0,r.startCapacity+r.delta), used:0}) );
      const prefBySen = new Map(); (prefs||[]).forEach(p=> prefBySen.set(Number(p.seniority)||0, Array.isArray(p.prefs)? p.prefs.slice() : []) );
      const out=[];
      for (const r of roster){
        let list=(prefBySen.get(r.seniority)||[]).map(parsePref).filter(Boolean);
        if (!list.length || list.some(x=>x.stay)){ list=[{base:r.currentBase, seat:r.currentSeat, stay:true}].concat(list.filter(x=>!x.stay)); }
        let awardedBase='', awardedSeat='', awardedPrefNum=0, note='';
        for (let i=0;i<list.length;i++){
          const pref=list[i]; const b=pref.base ?? r.currentBase; const s=pref.seat ?? r.currentSeat;
          const rec=capMap.get(key(b,s));
          if (rec && rec.used < rec.cap){ rec.used++; awardedBase=b; awardedSeat=s; awardedPrefNum=i+1; note=pref.stay?'Stayed (Pref 1 = current)':'Awarded pref #'+awardedPrefNum; break; }
        }
        if (!awardedBase){
          const rec2=capMap.get(key(r.currentBase,r.currentSeat));
          if (rec2 && rec2.used < rec2.cap){ rec2.used++; awardedBase=r.currentBase; awardedSeat=r.currentSeat; awardedPrefNum=0; note='Stayed (capacity)'; }
          else { note='UNPLACED – no capacity'; }
        }
        out.push({ seniority:r.seniority, name:r.name, fromBase:r.currentBase, fromSeat:r.currentSeat, awardedBase, awardedSeat, awardedPrefNum, moved:(awardedBase!==r.currentBase)||(awardedSeat!==r.currentSeat), upgrade:(r.currentSeat==='FO'&&awardedSeat==='CA'), note });
      }
      results=out; renderResults();
    }

    // ---------- Results ----------
    function renderResults(){
      const holder=$('resultsTable'); holder.innerHTML='';
      if (!results.length){ holder.appendChild(el('div',{class:'empty'}, 'Run the cascade to see awards.')); $('summary').textContent='No run yet'; $('btnCSV').disabled=true; return; }
      const q=$('q').value.trim().toLowerCase(), mv=$('fltMove').value, fb=$('fltBase').value, fs=$('fltSeat').value;
      let rows=results.slice();
      if (mv==='movers') rows=rows.filter(r=>r.moved);
      if (mv==='upgrades') rows=rows.filter(r=>r.upgrade);
      if (fb) rows=rows.filter(r=>r.awardedBase===fb);
      if (fs) rows=rows.filter(r=>r.awardedSeat===fs);
      if (q) rows=rows.filter(r=> String(r.seniority).includes(q) || (r.name||'').toLowerCase().includes(q) );
      $('summary').textContent = `${rows.length} shown • ${results.length} total`; $('btnCSV').disabled = rows.length===0;

      const tbl=el('table'); const thead=el('thead',{}, el('tr',{}, el('th',{},'Seniority'), el('th',{},'Pilot'), el('th',{},'From'), el('th',{},'Awarded'), el('th',{},'Pref #'), el('th',{},'Tags'), el('th',{},'Note'))); const tbody=el('tbody');
      rows.forEach(r=>{
        const tags=[]; if (r.moved) tags.push('<span class="pill">moved</span>'); if (r.upgrade) tags.push('<span class="pill">upgrade</span>'); if (!r.moved && !r.upgrade) tags.push('<span class="pill">no change</span>');
        const tr=el('tr',{}, el('td',{}, String(r.seniority)), el('td',{}, r.name), el('td',{}, `${r.fromBase} ${r.fromSeat}`), el('td',{}, `${r.awardedBase} ${r.awardedSeat}`), el('td',{}, String(r.awardedPrefNum)), el('td',{html:tags.join(' ')}), el('td',{}, r.note||''));
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody); holder.appendChild(tbl);
    }

    // ---------- CSV ----------
    $('btnCSV').addEventListener('click', ()=>{
      if (!results.length) return;
      const headers=['Seniority','Pilot_Name','From_Base','From_Seat','Awarded_Base','Awarded_Seat','Awarded_Pref_Num','Moved','Upgrade','Note'];
      const rows=results.map(r=>({'Seniority':r.seniority,'Pilot_Name':r.name,'From_Base':r.fromBase,'From_Seat':r.fromSeat,'Awarded_Base':r.awardedBase,'Awarded_Seat':r.awardedSeat,'Awarded_Pref_Num':r.awardedPrefNum,'Moved':r.moved?'Y':'','Upgrade':r.upgrade?'Y':'','Note':r.note||''}));
      const csv=toCSV(rows, headers); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='frozen_bid_results.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    // ---------- Manual Load / File Pickers ----------
    $('btnFetch').addEventListener('click', async ()=>{ try{ await fetchDefault(); $('btnFetch').style.display='none'; } catch(e){ alert('Could not fetch /data/*.json. Ensure files exist.\n\n'+e); } });
    $('fCap').addEventListener('change', async (e)=>{ capacities = await readLocalJSON(e.target.files[0]); normalizeState(); $('status').textContent='capacities loaded'; });
    $('fRos').addEventListener('change', async (e)=>{ roster     = await readLocalJSON(e.target.files[0]); normalizeState(); $('status').textContent='roster loaded'; });
    $('fPref').addEventListener('change', async (e)=>{ prefs      = await readLocalJSON(e.target.files[0]); normalizeState(); $('status').textContent='preferences loaded'; });

    // ---------- Filters ----------
    ['q','fltMove','fltBase','fltSeat'].forEach(id=>{
      $(id).addEventListener('input', renderResults);
      $(id).addEventListener('change', renderResults);
    });
    $('btnClear').addEventListener('click', ()=>{ $('q').value=''; $('fltMove').value='all'; $('fltBase').value=''; $('fltSeat').value=''; renderResults(); });
  </script>
</body>
</html>
