<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>BaseBid - Who's In Line (What-If)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-app:#0f172a; --bg-panel:#111c33; --bg-panel-2:#0b1220; --bg-input:#020617;
      --border:#24324a; --text:#f1f5f9; --muted:#93a4bd;
      --accent:#3b82f6; --good:#22c55e; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 700px at 20% 0%, rgba(59,130,246,.15), transparent 55%),
                 radial-gradient(1000px 600px at 80% 20%, rgba(34,197,94,.08), transparent 55%),
                 var(--bg-app);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      height:100vh;
      overflow:hidden; /* panels scroll */
    }

    /* Left panel */
    .sidebar{
      width:420px;
      height:100vh;
      overflow:auto;
      background:linear-gradient(180deg, rgba(17,28,51,.95), rgba(11,18,32,.95));
      border-right:1px solid var(--border);
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .brand .logo{
      font-weight:900;
      letter-spacing:-.02em;
      color:var(--accent);
      font-size:20px;
    }
    .brand .tag{
      font-size:12px;
      color:var(--muted);
      font-family:"JetBrains Mono", monospace;
    }
    .desc{
      font-size:13px;
      line-height:1.55;
      color:var(--muted);
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      padding:12px 12px;
      border-radius:14px;
    }
    .desc b{color:#fff}
    .group{display:flex; flex-direction:column; gap:8px}
    label{
      font-size:11px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
    }
    input, select{
      width:100%;
      background:rgba(2,6,23,.7);
      border:1px solid var(--border);
      color:#fff;
      padding:12px 12px;
      border-radius:12px;
      font-size:14px;
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(59,130,246,.85)}
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .btn{
      background:linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      border:none;
      color:#fff;
      padding:13px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.02em;
      box-shadow:0 10px 30px rgba(59,130,246,.18);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .mini{
      font-size:12px;
      color:var(--muted);
      border:1px dashed var(--border);
      border-radius:14px;
      padding:12px;
      line-height:1.55;
    }
    .mini b{color:#fff}

    /* Right panel */
    .main{
      flex:1;
      height:100vh;
      overflow:auto;
      padding:22px;
    }
    .card{
      width:min(1120px, 100%);
      margin:0 auto 18px auto;
      background:linear-gradient(180deg, rgba(17,28,51,.92), rgba(11,18,32,.92));
      border:1px solid var(--border);
      border-radius:18px;
      padding:22px;
      box-shadow:0 16px 60px rgba(0,0,0,.35);
    }
    .title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      font-weight:900;
      color:var(--muted);
      margin:0 0 10px 0;
    }
    .headline{
      margin:0;
      font-size:26px;
      line-height:1.35;
      font-weight:650;
    }
    .headline b{color:var(--accent)}
    .ok{color:var(--good); font-weight:900}
    .no{color:var(--bad); font-weight:900; text-decoration:underline}

    .meta{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(4, minmax(170px, 1fr));
      gap:10px;
    }
    .box{
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .k{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:900;
      margin-bottom:6px;
    }
    .v{
      font-family:"JetBrains Mono", monospace;
      color:#fff;
      font-size:13px;
    }

    .tableHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-top:18px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    .pill{
      font-family:"JetBrains Mono", monospace;
      font-size:12px;
      color:#cbd5e1;
      border:1px solid var(--border);
      background:rgba(2,6,23,.25);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .scrollX{overflow-x:auto; padding-bottom:4px}
    table{
      width:100%;
      min-width:880px;
      border-collapse:separate;
      border-spacing:0 10px;
    }
    thead th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:900;
      padding:0 12px;
      white-space:nowrap;
    }
    tbody tr{background:rgba(2,6,23,.38)}
    tbody td{
      padding:12px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      color:#e2e8f0;
      font-size:13px;
      vertical-align:top;
    }
    tbody td:first-child{
      border-left:1px solid var(--border);
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
      font-family:"JetBrains Mono", monospace;
      white-space:nowrap;
    }
    tbody td:last-child{
      border-right:1px solid var(--border);
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
    }
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .mono{font-family:"JetBrains Mono", monospace}

    /* Loading / error overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.75);
      backdrop-filter: blur(4px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:20px;
    }
    .overlayBox{
      width:min(980px, 100%);
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      color:#cbd5e1;
    }
    .overlayTitle{
      font-weight:900;
      color:#fff;
      margin-bottom:10px;
    }
    .errTitle{color:var(--bad)}
    pre{
      margin:0;
      white-space:pre-wrap;
      font-family:"JetBrains Mono", monospace;
      font-size:12px;
      line-height:1.45;
      color:#cbd5e1;
    }

    @media (max-width: 980px){
      body{flex-direction:column; overflow:auto; height:auto}
      .sidebar{width:100%; height:auto; border-right:none; border-bottom:1px solid var(--border)}
      .main{height:auto}
      .meta{grid-template-columns:repeat(2, minmax(170px, 1fr))}
      table{min-width:760px}
    }
  </style>

  <script>
    // GitHub Pages project-site trap: /repo vs /repo/
    (function forceTrailingSlash(){
      const p = location.pathname;
      const last = p.split('/').pop() || '';
      const looksLikeFile = last.includes('.');
      if (!looksLikeFile && !p.endsWith('/')) location.replace(p + '/' + location.search + location.hash);
    })();
  </script>
</head>

<body>
  <div id="overlay" class="overlay">
    <div class="overlayBox">
      <div class="overlayTitle">Loading roster.json + preferences.json…</div>
      <div class="muted">If this hangs, your JSON filenames or paths are wrong.</div>
    </div>
  </div>

  <aside class="sidebar">
    <div class="brand">
      <div class="logo">BASEBID</div>
      <div class="tag">what-if tool</div>
    </div>

    <div class="desc">
      <b>Current</b> base/seat comes from <b>roster.json</b>.<br>
      <b>Preferences</b> come from <b>preferences.json</b> in the new format:
      <span class="mono">{ order, bid }</span>.<br><br>
      Rules:
      <br>• <b>order = 0</b> or <b>blank bid</b> = <b>stay</b> (pilot counts for nothing)
      <br>• A senior pilot counts “in line” if they list the <b>target base/seat</b> in any non-stay preference
      <br>• Pilots already holding the target are <b>not</b> counted
    </div>

    <div class="group">
      <label>Your seniority number</label>
      <input id="senInput" type="text" placeholder="e.g. 2670">
    </div>

    <div class="row2">
      <div class="group">
        <label>Target base</label>
        <select id="baseInput">
          <option value="ANC">ANC</option>
          <option value="LAX">LAX</option>
          <option value="PDX">PDX</option>
          <option value="SAN">SAN</option>
          <option value="SEA">SEA</option>
          <option value="SFO">SFO</option>
        </select>
      </div>

      <div class="group">
        <label>Target seat</label>
        <select id="seatInput">
          <option value="CA">CA</option>
          <option value="FO">FO</option>
        </select>
      </div>
    </div>

    <div class="group">
      <label>What-if openings</label>
      <input id="openingsInput" type="number" min="0" value="0" placeholder="e.g. 20">
    </div>

    <button class="btn" id="runBtn">Run</button>

    <div class="mini">
      <b>Output:</b><br>
      • <b>Your position</b> = (# senior competitors) + 1 (you)<br>
      • “Clear” if <b>openings ≥ position</b><br>
      • List shows only <b>senior competitors</b> + their first matching bid
    </div>
  </aside>

  <main class="main">
    <section class="card" id="introCard">
      <div class="title">Ready</div>
      <p class="headline" style="color:var(--muted); font-size:20px;">
        Enter your seniority number, pick a target base/seat, then hit <b>Run</b>.
      </p>
    </section>

    <section class="card" id="resultsCard" style="display:none;">
      <div class="title">Results</div>
      <p class="headline" id="headline"></p>

      <div class="meta">
        <div class="box"><div class="k">Pilot</div><div class="v" id="mName">—</div></div>
        <div class="box"><div class="k">Seniority</div><div class="v" id="mSen">—</div></div>
        <div class="box"><div class="k">Current</div><div class="v" id="mCur">—</div></div>
        <div class="box"><div class="k">Target</div><div class="v" id="mTgt">—</div></div>

        <div class="box"><div class="k">Senior competitors</div><div class="v" id="mSeniors">—</div></div>
        <div class="box"><div class="k">Your position</div><div class="v" id="mPos">—</div></div>
        <div class="box"><div class="k">Openings</div><div class="v" id="mOpen">—</div></div>
        <div class="box"><div class="k">Clear?</div><div class="v" id="mClear">—</div></div>
      </div>

      <div class="tableHeader">
        <div class="title" style="margin:0;">Senior competitors ahead of you</div>
        <div class="pill"><span id="listCount">0</span> shown</div>
      </div>

      <div class="scrollX">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">Sen</th>
              <th style="width:270px;">Name</th>
              <th style="width:200px;">Current</th>
              <th style="width:120px;">Pref #</th>
              <th>Matched bid</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="muted">Run a query…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ----------------------------
    // Helpers
    // ----------------------------
    function baseDirUrl(){
      const u = new URL(location.href);
      if (!u.pathname.endsWith('/')) u.pathname = u.pathname.replace(/\/[^/]*$/, '/');
      return u.toString();
    }

    async function fetchJson(filename){
      const url = new URL(filename, baseDirUrl()).toString();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok){
        const body = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} loading ${filename}\nURL: ${url}\n${body ? `Body:\n${body.slice(0,300)}` : ''}`);
      }
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch(e){ throw new Error(`Invalid JSON in ${filename}\nURL: ${url}\n${e.message}\nFirst 300 chars:\n${txt.slice(0,300)}`); }
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function fmtCurrent(p){
      const c = p.current || {};
      const eq = c.equip ? (String(c.equip) + ' ') : '';
      return `${eq}${c.base || '?'} ${c.seat || '?'}`.trim();
    }

    // Accept "73G SAN CA" or "737 SAN CA" or "SAN CA"
    function parseBidToBaseSeat(bidStr){
      const parts = String(bidStr || '').trim().split(/\s+/);
      if (parts.length === 3) return { base: parts[1], seat: parts[2] };
      if (parts.length === 2) return { base: parts[0], seat: parts[1] };
      return { base: null, seat: null };
    }

    // ----------------------------
    // Preferences (NEW FORMAT)
    // prefs[pilotId].preferences = [{order:0,bid:"",...},{order:1,bid:"73G SAN CA",...}]
    // STAY rows: order==0 OR bid blank
    // Also supports older formats as a fallback.
    // Returns array of {order:number, bid:string}
    // ----------------------------
    function normalizePrefList(prefEntry){
      if (!prefEntry) return [];

      // New format
      if (Array.isArray(prefEntry.preferences) && prefEntry.preferences.length && typeof prefEntry.preferences[0] === 'object'){
        return prefEntry.preferences
          .map(x => ({
            order: Number(x.order ?? 0),
            bid: (typeof x.bid === 'string' ? x.bid.trim() : '')
          }))
          .sort((a,b)=> a.order - b.order);
      }

      // Old format fallback: preferences is array of strings
      if (Array.isArray(prefEntry.preferences)){
        return prefEntry.preferences.map((bid, i) => ({ order: i+1, bid: String(bid||'').trim() }));
      }

      // Old nested fallback: preferences.preferences is array of strings
      if (prefEntry.preferences && Array.isArray(prefEntry.preferences.preferences)){
        return prefEntry.preferences.preferences.map((bid, i) => ({ order: i+1, bid: String(bid||'').trim() }));
      }

      return [];
    }

    // Returns list of non-stay bids, ordered, with base/seat parsed
    function getActiveBids(prefEntry){
      const lst = normalizePrefList(prefEntry);

      // Filter out stay: order==0 OR bid blank
      const active = lst.filter(x => x.order > 0 && x.bid.length > 0);

      // De-dupe by base|seat while preserving first occurrence (prevents repeated bids)
      const out = [];
      const seen = new Set();
      for (const x of active){
        const bs = parseBidToBaseSeat(x.bid);
        if (!bs.base || !bs.seat) continue;
        const key = `${bs.base}|${bs.seat}`;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({ order: x.order, bid: x.bid, base: bs.base, seat: bs.seat });
      }
      return out;
    }

    // ----------------------------
    // App state
    // ----------------------------
    let ROSTER = [];
    let PREFS = {};

    function setOverlayError(err){
      const el = document.getElementById('overlay');
      el.innerHTML = `
        <div class="overlayBox">
          <div class="overlayTitle errTitle">Error loading JSON</div>
          <pre>${escapeHtml(String(err))}</pre>
          <div class="muted" style="margin-top:10px; font-size:13px; line-height:1.5;">
            Checklist:
            <br>• Files must be in the same folder as <span class="mono">index.html</span>
            <br>• Filenames must be exactly <span class="mono">roster.json</span> and <span class="mono">preferences.json</span>
            <br>• GitHub Pages project sites must use a trailing slash: <span class="mono">.../basesbid/</span>
          </div>
        </div>
      `;
    }

    function hideOverlay(){
      document.getElementById('overlay').style.display = 'none';
    }

    function showResults(){
      document.getElementById('introCard').style.display = 'none';
      document.getElementById('resultsCard').style.display = 'block';
      document.querySelector('.main').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function setText(id, val){ document.getElementById(id).textContent = val; }

    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      const countEl = document.getElementById('listCount');
      countEl.textContent = String(rows.length);

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No senior competitors found for this target.</td></tr>`;
        return;
      }

      const html = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.sen)}</td>
          <td>${escapeHtml(r.name)}</td>
          <td class="mono nowrap">${escapeHtml(r.current)}</td>
          <td class="mono">${escapeHtml(r.prefOrder)}</td>
          <td class="mono">${escapeHtml(r.matchedBid)}</td>
        </tr>
      `).join('');
      tbody.innerHTML = html;
    }

    function run(){
      const senStr = document.getElementById('senInput').value.trim();
      const tBase = document.getElementById('baseInput').value;
      const tSeat = document.getElementById('seatInput').value;
      const openings = Math.max(0, Number(document.getElementById('openingsInput').value || 0));

      if (!senStr){ alert('Enter your seniority number.'); return; }

      const user = ROSTER.find(p => String(p.sen) === senStr);
      if (!user){ alert('Seniority number not found in roster.json.'); return; }

      showResults();

      const userSen = Number(user.sen);
      const userName = (String(user.name||'').split(',')[0] || String(user.name||'') || '—').trim();

      setText('mName', userName);
      setText('mSen', `#${user.sen}`);
      setText('mCur', fmtCurrent(user));
      setText('mTgt', `${tBase} ${tSeat}`);
      setText('mOpen', String(openings));

      // If you already hold target, we don't compute a "line"
      if (user.current?.base === tBase && user.current?.seat === tSeat){
        setText('mSeniors', '—');
        setText('mPos', '—');
        setText('mClear', '—');
        document.getElementById('headline').innerHTML =
          `You already hold <b>${tBase} ${tSeat}</b>.<br><span class="ok">This tool is for people trying to move into a target.</span>`;
        renderTable([]);
        return;
      }

      const competitors = [];

      for (const p of ROSTER){
        if (Number(p.sen) >= userSen) continue; // only senior to user

        // If pilot already in target, they don't count
        if (p.current?.base === tBase && p.current?.seat === tSeat) continue;

        const activeBids = getActiveBids(PREFS[p.id]);

        // STAY = no active bids
        if (activeBids.length === 0) continue;

        // Find first matching bid for target
        const match = activeBids.find(x => x.base === tBase && x.seat === tSeat);
        if (!match) continue;

        competitors.push({
          sen: p.sen,
          name: p.name || '',
          current: fmtCurrent(p),
          prefOrder: match.order,
          matchedBid: match.bid
        });
      }

      competitors.sort((a,b) => Number(a.sen) - Number(b.sen));

      const seniors = competitors.length;
      const position = seniors + 1;
      const clears = openings >= position;

      setText('mSeniors', String(seniors));
      setText('mPos', String(position));
      setText('mClear', clears ? 'YES' : 'NO');

      renderTable(competitors);

      if (clears){
        document.getElementById('headline').innerHTML =
          `There are <b>${position}</b> in line for <b>${tBase} ${tSeat}</b> (including you).<br>` +
          `<span class="ok">With ${openings} openings, you clear.</span>`;
      } else {
        const shortBy = position - openings;
        document.getElementById('headline').innerHTML =
          `There are <b>${position}</b> in line for <b>${tBase} ${tSeat}</b> (including you).<br>` +
          `With ${openings} openings, you’re short by <span class="no">${shortBy}</span>.`;
      }
    }

    async function init(){
      try{
        const [r, p] = await Promise.all([
          fetchJson('roster.json'),
          fetchJson('preferences.json')
        ]);
        ROSTER = Array.isArray(r) ? r : [];
        PREFS = (p && typeof p === 'object') ? p : {};
        hideOverlay();
      } catch (err){
        setOverlayError(err);
      }
    }

    document.getElementById('runBtn').addEventListener('click', run);
    document.getElementById('senInput').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') run(); });

    init();
  </script>
</body>
</html>
