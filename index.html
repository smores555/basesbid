<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Vacancy Cascade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{ --fg:#101828; --muted:#667085; --bg:#f7f9fc; --card:#fff; --line:#e6eaf0; --accent:#2f6df6; }
    *{box-sizing:border-box} html,body{margin:0;color:var(--fg);background:#f7f9fc;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .status{font-size:12px;padding:3px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .status.ok{background:#eef7ff;border-color:#cfe4ff}
    .status.err{background:#fff2f2;border-color:#ffd7dc;color:#a61e2a}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px;max-width:1400px;margin:0 auto}
    section.card,aside.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(16,24,40,.05)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)} input,select{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
    button{border:1px solid var(--line);background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer} button.ghost{background:#fff;color:#111}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
    thead th{position:sticky;top:0;z-index:1;background:#fbfdff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}
    .cap-grid{max-height:65vh;overflow:auto} .empty{padding:24px;text-align:center;color:var(--muted)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .tag-move{background:#eef2ff;border-color:#d9e1ff} .tag-up{background:#fff6e6;border-color:#ffe1b3} .tag-stay{background:#e9fbf3;border-color:#cfeee1}
    .statbar{display:grid;grid-auto-flow:column;gap:8px} .stat{background:#f5f8ff;border:1px solid var(--line);padding:6px 10px;border-radius:8px;font-size:12px}
    @media (max-width: 1024px){ main{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Vacancy Cascade</h1>
      <span id="status" class="status">Booting…</span>
    </div>
    <div class="row">
      <label class="row" style="font-size:12px">
        Mode:
        <select id="mode">
          <option value="upgrades">CA Δ = Upgrades only (FO→CA)</option>
          <option value="compete">CA Δ = CA/FO compete by seniority</option>
        </select>
      </label>
      <button id="btnCSV" class="ghost" disabled>Export CSV</button>
    </div>
  </header>

  <main>
    <aside class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0;font-size:14px">Vacancy Controls</h3>
        <label class="muted" style="display:flex;align-items:center;gap:6px;font-size:12px">
          <input id="autoRun" type="checkbox" checked> Auto-run after edits
        </label>
      </div>
      <div class="muted" style="font-size:12px;margin:6px 0 10px">
        Reads <code>capacities.json</code> (dict with <code>incumbents/target</code>), <code>roster.json</code> (array with <code>current</code>), and rich <code>preferences.json</code> (object with detailed rows). BPL applies only when filed (>0).
      </div>
      <div class="row" style="margin-bottom:8px">
        <select id="qBase"></select>
        <select id="qSeat"><option>CA</option><option>FO</option></select>
        <input id="qAmt" type="number" value="1" style="width:90px"/>
        <button id="qApply" class="ghost">Apply Δ</button>
      </div>
      <div id="capGrid" class="cap-grid"></div>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="row">
          <span class="muted">Nudge all:</span>
          <button class="ghost" data-nudge="+1">+1</button>
          <button class="ghost" data-nudge="+5">+5</button>
          <button class="ghost" data-nudge="+10">+10</button>
          <button class="ghost" data-nudge="-1">−1</button>
          <button class="ghost" data-nudge="-5">−5</button>
          <button class="ghost" data-nudge="-10">−10</button>
        </div>
        <button id="btnReset" class="ghost">Reset Deltas</button>
      </div>
    </aside>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <strong>Awards</strong>
          <input id="q" type="text" placeholder="Search name or seniority…" style="width:220px;margin-left:10px"/>
          <select id="fltMove">
            <option value="all">All awards</option>
            <option value="movers">Movers only</option>
            <option value="upgrades">Upgrades only</option>
          </select>
          <select id="fltBase"><option value="">Awarded Base: All</option></select>
          <select id="fltSeat"><option value="">Awarded Seat: All</option><option>CA</option><option>FO</option></select>
          <button id="btnClear" class="ghost">Clear</button>
        </div>
        <div class="statbar">
          <div class="stat">Shown <b id="shown">0</b></div>
          <div class="stat">Total <b id="total">0</b></div>
          <div class="stat">Upgrades <b id="upCnt">0</b></div>
          <div class="stat">Movers <b id="mvCnt">0</b></div>
        </div>
      </div>
      <div id="results" style="max-height:68vh;overflow:auto;margin-top:8px">
        <div class="empty">Loading data and running cascade…</div>
      </div>
    </section>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    const asInt = v => (v==null||v==='')?0:(Number(v)||0);
    const key = (b,s)=> String(b).toUpperCase()+'|'+String(s).toUpperCase();

    function parsePrefString(s){
      const t = String(s || '').trim().toUpperCase();
      if (!t) return null;
      if (t === '0') return { base: null, seat: null, stay: true };
      const parts = t.replace(/\s*[-/]\s*/g, ' ').split(/\s+/).filter(Boolean);
      if (parts.length >= 2) {
        const seat = parts[parts.length - 1];
        const base = parts[parts.length - 2];
        return { base, seat, stay: false };
      }
      return null;
    }

    async function fetchJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error(url+' '+r.status);
      return r.json();
    }

    let CAP=[], ROST=[], PREF_MAP=new Map(), PREF_DETAILS=new Map(), RESULTS=[];

    (async function init(){
      try{
        const base = new URL('data/', document.baseURI);
        const [caps, rost, prefs] = await Promise.all([
          fetchJSON(new URL('capacities.json', base)),
          fetchJSON(new URL('roster.json', base)),
          fetchJSON(new URL('preferences.json', base)),
        ]);

        // Normalize capacities (dict: seatKey -> {incumbents,target})
        // We render as an array with base, seat, incumbents, delta (=target-incumbents)
        CAP = Object.entries(caps||{}).map(([seatKey,obj])=>{
          const [equip,baseStr,seatStr] = String(seatKey).split('|'); // equip is ignored for gating
          const incumbents = asInt(obj?.incumbents);
          const target = asInt(obj?.target);
          return { base: baseStr.toUpperCase(), seat: seatStr.toUpperCase(), incumbents, delta: (target - incumbents) };
        }).sort((a,b)=> a.base.localeCompare(b.base) || a.seat.localeCompare(b.seat));

        // Normalize roster (array with current {equip,base,seat})
        ROST = (rost||[]).map(r=>({
          seniority: asInt(r.sen ?? r.seniority ?? r.Sen),
          name: String(r.name||''),
          currentBase: String(r.current?.base || r.currentBase || '').toUpperCase(),
          currentSeat: String(r.current?.seat || r.currentSeat || '').toUpperCase(),
        })).filter(r=>r.seniority>0).sort((a,b)=>a.seniority-b.seniority);

        // Normalize preferences (rich object keyed by id)
        PREF_MAP = new Map();     // sen -> ["SEA CA","0",...]
        PREF_DETAILS = new Map(); // sen -> detailed rows
        Object.values(prefs||{}).forEach(p=>{
          const sen = asInt(p.sen ?? p.seniority ?? p.Sen);
          const arr = Array.isArray(p.preferences)? [...p.preferences]: [];
          arr.sort((a,b)=> (a.order??0)-(b.order??0));
          const strings = arr.map(x=> x.stay? '0' : [x.base,x.seat].filter(Boolean).join(' ')).filter(Boolean);
          PREF_MAP.set(sen, strings);
          // normalize detail rows to upper-case base/seat and fallback bpl_min
          const det = arr.map(x=> ({
            order: asInt(x.order),
            stay: !!x.stay,
            equip: x.equip || '',
            base: String(x.base||'').toUpperCase(),
            seat: String(x.seat||'').toUpperCase(),
            bpl_min: asInt(x.bpl_min || x.bpl || 0)
          }));
          PREF_DETAILS.set(sen, det);
        });

        buildCapUI();
        runCascade();
        setStatus(`Loaded & cascaded • ${ROST.length} pilots`, true);
      }catch(e){
        setStatus('Load failed', false);
        $('results').innerHTML = `<div class="empty">Couldn’t auto-load /data/*.json. ${e}</div>`;
      }
    })();

    function setStatus(t, ok){ const s=$('status'); s.textContent=t; s.classList.remove('err','ok'); s.classList.add(ok?'ok':'err'); }

    function buildCapUI(){
      const bases=[...new Set(CAP.map(c=>c.base))].sort();
      $('qBase').innerHTML = bases.map(b=>`<option>${b}</option>`).join('');
      $('fltBase').innerHTML = '<option value="">Awarded Base: All</option>' + bases.map(b=>`<option>${b}</option>`).join('');

      const holder=$('capGrid'); holder.innerHTML='';
      let cur=null, tbl=null, tbody=null;
      CAP.forEach(c=>{
        if (c.base!==cur){
          cur=c.base; tbl=document.createElement('table'); const thead=document.createElement('thead'); const tr=document.createElement('tr');
          ['Base','Seat','Seeded Δ','Backfill Vacancies (dynamic)'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); });
          thead.appendChild(tr); tbl.appendChild(thead); tbody=document.createElement('tbody'); tbl.appendChild(tbody); holder.appendChild(tbl);
        }
        const seededCell=document.createElement('td'); const pill1=document.createElement('span'); pill1.className='pill'; pill1.textContent=String(c.delta); seededCell.appendChild(pill1);
        const backfillCell=document.createElement('td'); const pill2=document.createElement('span'); pill2.className='pill'; pill2.textContent='0'; backfillCell.appendChild(pill2);
        const inp=document.createElement('input'); inp.type='number'; inp.value=String(c.delta); inp.style.width='90px';
        const row=document.createElement('tr');
        row.appendChild(cell(c.base));
        row.appendChild(cell(c.seat));
        const deltaCell=cell(); const wrap=document.createElement('div'); wrap.className='row';
        wrap.appendChild(btn('–', ()=>{ c.delta--; inp.value=String(c.delta); pill1.textContent=String(c.delta); if ($('autoRun').checked) runCascade(); }));
        wrap.appendChild(inp);
        wrap.appendChild(btn('+', ()=>{ c.delta++; inp.value=String(c.delta); pill1.textContent=String(c.delta); if ($('autoRun').checked) runCascade(); }));
        deltaCell.appendChild(wrap);
        row.appendChild(deltaCell);
        row.appendChild(backfillCell);
        inp.addEventListener('input', ()=>{ c.delta=asInt(inp.value); pill1.textContent=String(c.delta); if ($('autoRun').checked) runCascade(); });
        tbody.appendChild(row);
        c._backfillPill = pill2;
      });
      function cell(txt=''){ const td=document.createElement('td'); td.textContent=txt; return td; }
      function btn(label,fn){ const b=document.createElement('button'); b.className='ghost'; b.textContent=label; b.addEventListener('click',fn); return b; }
    }

    ['mode'].forEach(id=> $(id).addEventListener('change', ()=> runCascade()));
    $('qApply').addEventListener('click', ()=>{
      const b=$('qBase').value, s=$('qSeat').value, amt=asInt($('qAmt').value)||0;
      CAP.forEach(c=>{ if(c.base===b && c.seat===s) c.delta += amt; });
      buildCapUI(); if ($('autoRun').checked) runCascade();
    });
    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('button[data-nudge]'); if(!btn) return;
      const n=asInt(btn.getAttribute('data-nudge'));
      CAP.forEach(c=> c.delta += n);
      buildCapUI(); if ($('autoRun').checked) runCascade();
    });
    $('btnReset').addEventListener('click', ()=>{
      CAP.forEach(c=> c.delta = 0);
      buildCapUI(); if ($('autoRun').checked) runCascade();
    });

    // ---- BPL helpers ----
    function seatKey(b,s){ return (String(b)+'|'+String(s)).toUpperCase(); }

    function initSeatRosters(pilots){
      const m = new Map();
      for (const r of pilots){
        const k = seatKey(r.currentBase, r.currentSeat);
        if (!m.has(k)) m.set(k, []);
        m.get(k).push(r.seniority);
      }
      for (const arr of m.values()) arr.sort((a,b)=>a-b);
      return m;
    }
    function projectRank(seatMap, k, seniority){
      const arr = seatMap.get(k) || [];
      let i=0; while (i<arr.length && arr[i] < seniority) i++;
      return i+1; // 1-based
    }
    function getBplMin(seniority, base, seat){
      const rows = PREF_DETAILS.get(seniority) || [];
      const b = String(base).toUpperCase(), s = String(seat).toUpperCase();
      const row = rows.find(r => !r.stay && String(r.base||'').toUpperCase()===b && String(r.seat||'').toUpperCase()===s);
      const n = row ? asInt(row.bpl_min || row.bpl || 0) : 0;
      return (n && n>0) ? n : 0;
    }
    // ---------------------

    function runCascade(){
      const mode = $('mode').value; // "upgrades" or "compete"
      const seeded = new Map(); // key -> seeded vacancies
      const backfill = new Map(); // key -> backfill vacancies

      CAP.forEach(c=>{
        const k=seatKey(c.base,c.seat);
        const v=Math.max(0, asInt(c.delta));
        seeded.set(k, v); backfill.set(k, 0);
      });

      const out=[];
      const pilots = ROST.map(r=>({ ...r }));
      const seatMap = initSeatRosters(pilots);

      for (const r of pilots){
        const raw = PREF_MAP.get(r.seniority) || [];
        let list = raw.map(parsePrefString).filter(Boolean);

        // Implicit stay: if current seat appears as a pref, mark it as stay
        const idxCurrent = list.findIndex(p=> (p.base??r.currentBase)===r.currentBase && (p.seat??r.currentSeat)===r.currentSeat);
        if (idxCurrent>=0){ list[idxCurrent] = {base:r.currentBase, seat:r.currentSeat, stay:true}; }
        const hasStay = list.some(x=>x.stay===true);
        if (hasStay){ list = list.map(x=> x.stay ? {base:r.currentBase, seat:r.currentSeat, stay:true} : x); }

        // Dedup exact base/seat combos in their list
        const seen=new Set(); list = list.filter(p=>{ const b=p.base??r.currentBase, s=p.seat??r.currentSeat; const k=seatKey(b,s); if(seen.has(k)) return false; seen.add(k); return true; });

        let awardedBase=r.currentBase, awardedSeat=r.currentSeat, awardedPrefNum=0, moved=false, upgrade=false, note='Stayed (no vacancy chain)';

        for (let i=0;i<list.length;i++){
          const pref=list[i]; const b=pref.base ?? r.currentBase; const s=pref.seat ?? r.currentSeat;
          const k=seatKey(b,s); const fromKey = seatKey(r.currentBase, r.currentSeat);

          if (b===r.currentBase && s===r.currentSeat){
            if (pref.stay){ awardedPrefNum=i+1; note='Stayed (listed current base/seat)'; }
            break;
          }

          let bf = backfill.get(k) || 0;
          let sd = seeded.get(k) || 0;
          if (bf<=0 && sd<=0) continue; // no vacancy to take

          // Enforce BPL only if filed (>0)
          const bplMin = getBplMin(r.seniority, b, s);
          if (bplMin > 0){
            const rank = projectRank(seatMap, k, r.seniority);
            if (rank > bplMin) continue;
          }

          // upgrades-only: seeded CA can only be consumed by FO upgrades
          if (bf<=0 && sd>0 && s==='CA' && mode==='upgrades'){
            const isUpgrade = (r.currentSeat==='FO');
            if (!isUpgrade) continue;
          }

          // Award
          if (bf>0){ backfill.set(k, bf-1); note = (s==='CA' && r.currentSeat==='FO')? 'Upgrade (FO→CA) • used backfill' : 'Awarded (lateral) • used backfill'; }
          else { seeded.set(k, sd-1); note = (s==='CA' && r.currentSeat==='FO')? 'Upgrade (FO→CA) • used seeded' : 'Awarded (lateral) • used seeded'; }

          // Origin backfill
          backfill.set(fromKey, (backfill.get(fromKey)||0)+1);

          // Keep seatMap in sync
          const originArr = seatMap.get(fromKey) || [];
          seatMap.set(fromKey, originArr.filter(sen => sen !== r.seniority));
          const dstArr = seatMap.get(k) || []; let j=0; while (j<dstArr.length && dstArr[j] < r.seniority) j++; dstArr.splice(j, 0, r.seniority); seatMap.set(k, dstArr);

          awardedBase=b; awardedSeat=s; awardedPrefNum=i+1; moved=true; upgrade=(r.currentSeat==='FO' && s==='CA');
          break;
        }

        out.push({seniority:r.seniority, name:r.name, fromBase:r.currentBase, fromSeat:r.currentSeat, awardedBase, awardedSeat, awardedPrefNum, moved, upgrade, note});
        r.currentBase=awardedBase; r.currentSeat=awardedSeat;
      }

      // update backfill pills
      CAP.forEach(c=>{
        const k=seatKey(c.base,c.seat);
        if (c._backfillPill) c._backfillPill.textContent = String(backfill.get(k)||0);
      });

      RESULTS=out;
      renderResults();
    }

    function renderResults(){
      const holder=$('results'); holder.innerHTML='';
      if (!RESULTS.length){ holder.innerHTML='<div class="empty">No awards yet.</div>'; return; }
      const q=$('q').value.trim().toLowerCase(), mv=$('fltMove').value, fb=$('fltBase').value, fs=$('fltSeat').value;
      let rows=RESULTS.slice();
      if (q) rows=rows.filter(r=> String(r.seniority).includes(q) || (r.name||'').toLowerCase().includes(q));
      if (mv==='movers') rows=rows.filter(r=>r.moved);
      if (mv==='upgrades') rows=rows.filter(r=>r.upgrade);
      if (fb) rows=rows.filter(r=>r.awardedBase===fb);
      if (fs) rows=rows.filter(r=>r.awardedSeat===fs);
      $('shown').textContent=rows.length; $('total').textContent=RESULTS.length; $('upCnt').textContent=RESULTS.filter(r=>r.upgrade).length; $('mvCnt').textContent=RESULTS.filter(r=>r.moved).length;

      const tbl=document.createElement('table'); const thead=document.createElement('thead'); const tr=document.createElement('tr');
      ['Seniority','Pilot','From','Awarded','Pref#','Tags','Note'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); });
      thead.appendChild(tr); tbl.appendChild(thead);
      const tbody=document.createElement('tbody');

      rows.forEach(r=>{
        const tags=[]; if (r.moved) tags.push('<span class="tag tag-move">moved</span>'); if (r.upgrade) tags.push('<span class="tag tag-up">upgrade</span>'); if (!r.moved && !r.upgrade) tags.push('<span class="tag tag-stay">no change</span>');
        const row=document.createElement('tr');
        const td=(t)=>{ const d=document.createElement('td'); d.innerHTML=t; return d; };
        row.appendChild(td(String(r.seniority)));
        row.appendChild(td(r.name||''));
        row.appendChild(td(`${r.fromBase} ${r.fromSeat}`));
        row.appendChild(td(`${r.awardedBase} ${r.awardedSeat}`));
        row.appendChild(td(String(r.awardedPrefNum)));
        row.appendChild(td(tags.join(' ')));
        row.appendChild(td(r.note||'')); tbody.appendChild(row);
      });
      tbl.appendChild(tbody); holder.appendChild(tbl);
      $('btnCSV').disabled = rows.length===0;
    }

    ['q','fltMove','fltBase','fltSeat'].forEach(id=>{ $(id).addEventListener('input', renderResults); $(id).addEventListener('change', renderResults); });
    $('btnClear').addEventListener('click', ()=>{ $('q').value=''; $('fltMove').value='all'; $('fltBase').value=''; $('fltSeat').value=''; renderResults(); });

    $('btnCSV').addEventListener('click', ()=>{
      const headers=['Seniority','Pilot_Name','From_Base','From_Seat','Awarded_Base','Awarded_Seat','Awarded_Pref_Num','Moved','Upgrade','Note'];
      const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`;
      const csv=[headers.join(',')].concat(RESULTS.map(r=>[
        r.seniority, r.name, r.fromBase, r.fromSeat, r.awardedBase, r.awardedSeat, r.awardedPrefNum, r.moved?'Y':'', r.upgrade?'Y':'', r.note||''
      ].map(esc).join(','))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vacancy_cascade_awards.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });
  </script>
</body>
</html>
