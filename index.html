<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ProTrace - Moving Line (What-If)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-app: #0f172a; --bg-panel: #1e293b; --bg-input: #020617;
      --border: #334155; --text-main: #f1f5f9; --text-muted: #94a3b8;
      --accent: #3b82f6; --danger: #ef4444; --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 380px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
    }
    .logo {
      font-weight: 900;
      font-size: 22px;
      color: var(--accent);
      letter-spacing: -1px;
      margin-bottom: 2px;
    }
    .sub {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.45;
      margin-top: -8px;
    }
    .sub b { color: white; }

    .input-group { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 11px; font-weight: 900; color: var(--text-muted); text-transform: uppercase; letter-spacing: .08em; }
    input, select {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: white;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      transition: border 0.15s, transform 0.05s;
    }
    input:focus, select:focus { border-color: var(--accent); }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor: pointer;
      letter-spacing: .02em;
      margin-top: 6px;
    }
    button:hover { filter: brightness(1.06); }
    button:active { transform: translateY(1px); }

    .mini {
      font-size: 12px;
      color: var(--text-muted);
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      line-height: 1.5;
    }
    .mini b { color: white; }

    .main {
      flex: 1;
      padding: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 34px;
      width: min(920px, 100%);
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .title {
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 900;
      margin-bottom: 10px;
    }

    .queue-msg {
      font-size: 26px;
      font-weight: 650;
      line-height: 1.5;
      color: var(--text-main);
      margin: 0;
    }
    .queue-msg b { color: var(--accent); }
    .highlight-red { color: var(--danger); font-weight: 900; text-decoration: underline; }
    .highlight-green { color: var(--success); font-weight: 900; }

    .meta {
      margin-top: 22px;
      padding-top: 18px;
      border-top: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap: 14px;
      font-size: 13px;
      color: var(--text-muted);
      text-align: left;
    }
    .meta .box {
      background: rgba(2,6,23,.45);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .meta b {
      color: white;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      word-break: break-word;
    }
    .meta .k {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .10em;
      margin-bottom: 6px;
      color: var(--text-muted);
      font-weight: 900;
    }

    .loader {
      position: fixed; inset: 0;
      background: var(--bg-app);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 24px;
      text-align: center;
    }
    .errbox {
      width: min(920px, 100%);
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 18px;
      text-align: left;
    }
    .errtitle { color: var(--danger); font-weight: 900; margin-bottom: 10px; }
    .errmono {
      font-family: 'JetBrains+Mono', monospace;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #cbd5e1;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .hint { margin-top: 12px; color: var(--text-muted); font-size: 13px; }
    .hint code { font-family: 'JetBrains Mono', monospace; color: #e2e8f0; font-size: 12px; }

    @media (max-width: 980px) {
      body { flex-direction: column; height: auto; overflow: auto; }
      .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
      .main { padding: 18px; }
      .meta { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
  </style>

  <script>
    // GitHub Pages project-site trap fix:
    // If you open /repo (no trailing slash), relative fetch('roster.json') resolves to /roster.json instead of /repo/roster.json.
    (function forceTrailingSlash() {
      const p = location.pathname;
      const last = p.split('/').pop() || '';
      const looksLikeFile = last.includes('.');
      if (!looksLikeFile && !p.endsWith('/')) {
        location.replace(p + '/' + location.search + location.hash);
      }
    })();
  </script>
</head>

<body>
  <div id="loadingScreen" class="loader">
    <div>Loading roster + preferences…</div>
  </div>

  <div class="sidebar">
    <div class="logo">PROTRACE</div>
    <div class="sub">
      This is a <b>what-if</b> tool for pilots <b>outside</b> their desired base/seat.<br>
      It computes the “moving line” ahead of you based on bid order rules:
      a senior pilot counts only if they hit <b>Target</b> before their <b>Current</b>.
      Pilots already holding the target are <b>not counted</b>.
    </div>

    <div class="input-group">
      <label>Pilot Seniority #</label>
      <input type="text" id="pilotSearch" placeholder="Ex: 2670">
    </div>

    <div class="input-group">
      <label>Target Base</label>
      <select id="targetBase">
        <option value="ANC">ANC</option>
        <option value="LAX">LAX</option>
        <option value="PDX">PDX</option>
        <option value="SAN">SAN</option>
        <option value="SEA">SEA</option>
        <option value="SFO">SFO</option>
      </select>
    </div>

    <div class="input-group">
      <label>Target Seat</label>
      <select id="targetSeat">
        <option value="CA">Captain (CA)</option>
        <option value="FO">First Officer (FO)</option>
      </select>
    </div>

    <div class="input-group">
      <label>Hypothetical Openings (What-If)</label>
      <input type="number" id="openings" min="0" value="0" placeholder="Ex: 20">
    </div>

    <button id="runBtn">Run What-If</button>

    <div class="mini">
      <b>Interpretation:</b><br>
      • <b>Your position</b> = (# senior competitors) + 1 (you).<br>
      • You “clear” if <b>openings ≥ your position</b>.<br>
      • If you already hold the target, we say so and stop.
    </div>
  </div>

  <div class="main">
    <div id="results" class="card" style="display:none;">
      <div class="title">Results</div>
      <p id="statusOutput" class="queue-msg"></p>

      <div class="meta">
        <div class="box">
          <div class="k">Pilot</div>
          <div><b id="resName">-</b></div>
        </div>
        <div class="box">
          <div class="k">Seniority</div>
          <div><b id="resSen">-</b></div>
        </div>
        <div class="box">
          <div class="k">Current</div>
          <div><b id="resCur">-</b></div>
        </div>
        <div class="box">
          <div class="k">Target</div>
          <div><b id="resTgt">-</b></div>
        </div>

        <div class="box">
          <div class="k">Senior competitors</div>
          <div><b id="resSeniors">-</b></div>
        </div>
        <div class="box">
          <div class="k">Your position</div>
          <div><b id="resPos">-</b></div>
        </div>
        <div class="box">
          <div class="k">Openings (what-if)</div>
          <div><b id="resOpen">-</b></div>
        </div>
        <div class="box">
          <div class="k">Clear?</div>
          <div><b id="resClear">-</b></div>
        </div>
      </div>
    </div>

    <div id="intro" class="card" style="background: transparent; border: 1px dashed var(--border); box-shadow: none;">
      <div class="title">ProTrace</div>
      <p class="queue-msg" style="font-size:20px; color: var(--text-muted);">
        Enter a seniority number, choose a target base/seat, and set a what-if openings count.
      </p>
    </div>
  </div>

  <script>
    // Data
    let ROSTER = [];
    let PREFS = {};

    // Resolve JSON relative to the directory containing this page (GitHub Pages-safe)
    function dirBaseUrl() {
      const u = new URL(location.href);
      if (!u.pathname.endsWith('/')) u.pathname = u.pathname.replace(/\/[^/]*$/, '/');
      return u.toString();
    }

    async function fetchJsonStrict(filename) {
      const url = new URL(filename, dirBaseUrl()).toString();
      const res = await fetch(url, { cache: "no-store" });

      if (!res.ok) {
        const body = await res.text().catch(() => "");
        throw new Error(
          `HTTP ${res.status} while loading ${filename}\nURL: ${url}\n` +
          (body ? `Body (first 300 chars):\n${body.slice(0, 300)}` : "")
        );
      }

      const raw = await res.text();
      try {
        return JSON.parse(raw);
      } catch (e) {
        throw new Error(
          `Invalid JSON in ${filename}\nURL: ${url}\nParse error: ${e.message}\n` +
          `First 300 chars:\n${raw.slice(0, 300)}`
        );
      }
    }

    function escapeHtml(s) {
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function showError(err) {
      const loading = document.getElementById('loadingScreen');
      loading.innerHTML = `
        <div class="errbox">
          <div class="errtitle">Error loading data</div>
          <div class="errmono">${escapeHtml(String(err))}</div>
          <div class="hint">
            Fix checklist:
            <ul>
              <li>Confirm these exist next to <code>index.html</code>: <code>roster.json</code>, <code>preferences.json</code></li>
              <li>Open the site with trailing slash: <code>.../basesbid/</code></li>
              <li>Try opening each JSON in the browser to confirm no 404</li>
            </ul>
          </div>
        </div>
      `;
    }

    // preferences.json can be either:
    //  - { "pil123": { "preferences": [...] } }
    //  - { "pil123": { "preferences": { "preferences": [...] } } }
    function normalizePrefsEntry(prefEntry) {
      if (!prefEntry) return null;
      if (Array.isArray(prefEntry.preferences)) return prefEntry.preferences;
      if (prefEntry.preferences && Array.isArray(prefEntry.preferences.preferences)) return prefEntry.preferences.preferences;
      return null;
    }

    // Accept "73G SEA CA" or "737 SEA CA"
    function parseBidString(bid) {
      const parts = String(bid || "").trim().split(/\s+/);
      if (parts.length === 3) return { equip: parts[0], base: parts[1], seat: parts[2] };
      if (parts.length === 2) return { equip: null, base: parts[0], seat: parts[1] };
      return { equip: null, base: null, seat: null };
    }

    function fmtCur(p) {
      const c = p.current || {};
      const eq = c.equip ? String(c.equip) + " " : "";
      return `${eq}${c.base || "?"} ${c.seat || "?"}`.trim();
    }

    function setText(id, value) {
      document.getElementById(id).textContent = value;
    }

    function showResults() {
      document.getElementById('intro').style.display = 'none';
      document.getElementById('results').style.display = 'block';
    }

    // CORE COMPETITOR LOGIC:
    // Count a senior pilot as a competitor ONLY if:
    //   1) They are senior to the user
    //   2) They do NOT already hold the target base/seat
    //   3) Their preference list hits TARGET base+seat BEFORE their CURRENT base+seat
    //      (If they hit current first, they "stick" and should NOT be counted for anything below)
    function countSeniorCompetitors(userSen, tBase, tSeat) {
      let count = 0;

      for (const p of ROSTER) {
        if (Number(p.sen) >= userSen) continue;

        // Key rule you asked for:
        // If they're already in the target, they are not competing for it.
        if (p.current?.base === tBase && p.current?.seat === tSeat) continue;

        const prefList = normalizePrefsEntry(PREFS[p.id]);
        if (!prefList) continue;

        const curBase = p.current?.base;
        const curSeat = p.current?.seat;

        let isCompetitor = false;

        for (const bid of prefList) {
          const b = parseBidString(bid);
          if (!b.base || !b.seat) continue;

          // Stop at current: they hold it and won't go below it
          if (b.base === curBase && b.seat === curSeat) {
            isCompetitor = false;
            break;
          }

          // Target before current => true competitor
          if (b.base === tBase && b.seat === tSeat) {
            isCompetitor = true;
            break;
          }
        }

        if (isCompetitor) count++;
      }

      return count;
    }

    function runAnalysis() {
      const query = document.getElementById('pilotSearch').value.trim();
      const tBase = document.getElementById('targetBase').value;
      const tSeat = document.getElementById('targetSeat').value;

      const openings = Math.max(0, Number(document.getElementById('openings').value || 0));

      if (!query) { alert("Enter a seniority number."); return; }

      const user = ROSTER.find(p => String(p.sen) === query);
      if (!user) { alert("Pilot not found in roster.json."); return; }

      const userSen = Number(user.sen);

      showResults();

      // Header fields
      setText('resName', (String(user.name || "").split(',')[0] || "-"));
      setText('resSen', "#" + user.sen);
      setText('resCur', fmtCur(user));
      setText('resTgt', `${tBase} ${tSeat}`);

      // This tool is for pilots OUTSIDE their desired base/seat.
      if (user.current?.base === tBase && user.current?.seat === tSeat) {
        setText('resSeniors', "—");
        setText('resPos', "—");
        setText('resOpen', String(openings));
        setText('resClear', "—");

        document.getElementById('statusOutput').innerHTML =
          `You already hold <b>${tBase} ${tSeat}</b>.<br>` +
          `<span class="highlight-green">This tool is intended for “getting into” a new base/seat.</span>`;

        return;
      }

      const seniorCompetitors = countSeniorCompetitors(userSen, tBase, tSeat);
      const position = seniorCompetitors + 1; // seniors + you
      const clears = openings >= position;

      setText('resSeniors', String(seniorCompetitors));
      setText('resPos', String(position));
      setText('resOpen', String(openings));
      setText('resClear', clears ? "YES" : "NO");

      if (clears) {
        document.getElementById('statusOutput').innerHTML =
          `There are <b>${position}</b> in the moving line for <b>${tBase} ${tSeat}</b> (including you).<br>` +
          `<span class="highlight-green">With ${openings} openings, you clear.</span>`;
      } else {
        const need = position - openings;
        document.getElementById('statusOutput').innerHTML =
          `There are <b>${position}</b> in the moving line for <b>${tBase} ${tSeat}</b> (including you).<br>` +
          `With ${openings} openings, you’re short by <span class="highlight-red">${need}</span>.`;
      }
    }

    async function init() {
      try {
        const [r, p] = await Promise.all([
          fetchJsonStrict('roster.json'),
          fetchJsonStrict('preferences.json')
        ]);

        ROSTER = Array.isArray(r) ? r : [];
        PREFS = (p && typeof p === "object") ? p : {};

        document.getElementById('loadingScreen').style.display = 'none';
      } catch (err) {
        showError(err);
      }
    }

    // Wiring
    document.getElementById('runBtn').addEventListener('click', runAnalysis);
    document.getElementById('pilotSearch').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') runAnalysis();
    });

    init();
  </script>
</body>
</html>
