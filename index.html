function calculateQueue() {
  const mySen = Number(document.getElementById('userSen').value);
  const tBase = document.getElementById('targetBase').value.toUpperCase();
  const tSeat = document.getElementById('targetSeat').value.toUpperCase();
  
  let realCompetitors = 0;
  let listHtml = "";

  // 1. Only look at pilots senior to you
  const seniors = roster.filter(p => Number(p.sen) < mySen).sort((a,b) => Number(a.sen) - Number(b.sen));

  seniors.forEach(p => {
    const pId = "pil" + p.sen;
    const pPrefsData = preferences[pId] || preferences[p.sen] || preferences[String(p.sen)];
    const pPrefsList = pPrefsData?.preferences || [];
    
    // Identify their current seat from the Roster (Master Source)
    const currentBase = String(p.current.base).toUpperCase();
    const currentSeat = String(p.current.seat).toUpperCase();

    let countingAsCompetitor = false;

    // 2. Step through their bids in ORDER (#1, #2, #3...)
    for (const bid of pPrefsList) {
      const bidBase = String(bid.base).toUpperCase();
      const bidSeat = String(bid.seat).toUpperCase();

      // IF THEY HIT YOUR TARGET FIRST: They are a real competitor
      if (bidBase === tBase && bidSeat === tSeat) {
        countingAsCompetitor = true;
        break; 
      }

      // IF THEY HIT THEIR CURRENT SEAT FIRST: They stay put. Stop looking.
      // Because they are senior, they are guaranteed to "hold" their current spot if they want it.
      if (bidBase === currentBase && bidSeat === currentSeat) {
        countingAsCompetitor = false;
        break; 
      }
    }

    if (countingAsCompetitor) {
      realCompetitors++;
      listHtml += `<div style="padding:6px 0; border-bottom: 1px solid #1e293b;">
        <b style="color:var(--accent)">#${p.sen}</b> - ${p.name.split(',')[0]}
      </div>`;
    }
  });

  // 3. Render the "Real" Queue Position
  document.getElementById('results').style.display = 'block';
  document.getElementById('queueOutput').innerHTML = `
    <div class="queue-card">
      <div style="font-size:12px; color:var(--text-muted); margin-bottom:5px;">REAL COMPETITORS AHEAD OF YOU</div>
      <div class="queue-val">${realCompetitors}</div>
      <div style="font-size:14px; margin-top:10px; line-height:1.6;">
        You are <b style="color:white">#${realCompetitors + 1}</b> in the actual queue.<br>
        You need <b style="color:var(--warning)">${realCompetitors + 1}</b> vacancies/attrition to hold.
      </div>
    </div>`;
  
  document.getElementById('seniorList').innerHTML = listHtml || "You are currently #1 in line!";
}
