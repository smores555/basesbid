<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProTrace - Seniority Queue</title>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --input: #020617;
      --text: #f1f5f9; --muted: #94a3b8; --accent: #3b82f6; --danger: #ef4444;
    }
    body { 
      background: var(--bg); color: var(--text); font-family: sans-serif; 
      margin: 0; display: flex; height: 100vh; 
    }
    .sidebar { 
      width: 320px; background: var(--card); border-right: 1px solid #334155; 
      padding: 20px; display: flex; flex-direction: column; gap: 15px; 
    }
    .main { flex: 1; padding: 40px; display: flex; justify-content: center; align-items: flex-start; }
    
    input, select, button { 
      background: var(--input); color: white; border: 1px solid #334155; 
      padding: 12px; border-radius: 6px; font-size: 14px; 
    }
    button { background: var(--accent); font-weight: bold; cursor: pointer; border: none; margin-top: 10px; }
    
    .result-card { 
      background: var(--card); border: 1px solid #334155; padding: 30px; 
      border-radius: 12px; width: 100%; max-width: 600px; text-align: center;
    }
    .queue-msg { font-size: 24px; line-height: 1.5; font-weight: 600; }
    .highlight { color: var(--accent); }
    .needed { color: var(--danger); text-decoration: underline; }
    
    .loading-overlay {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">Loading Roster & Preferences...</div>

  <div class="sidebar">
    <h2 style="color: var(--accent); margin-top:0;">ProTrace</h2>
    <label>Search Seniority #</label>
    <input type="text" id="pilotSearch" placeholder="Ex: 3388">
    
    <label>Target Base</label>
    <select id="targetBase">
      <option value="ANC">ANC</option>
      <option value="LAX">LAX</option>
      <option value="PDX">PDX</option>
      <option value="SAN">SAN</option>
      <option value="SEA">SEA</option>
      <option value="SFO">SFO</option>
    </select>

    <label>Target Seat</label>
    <select id="targetSeat">
      <option value="CA">Captain (CA)</option>
      <option value="FO">First Officer (FO)</option>
    </select>

    <button onclick="runAnalysis()">Update Analysis</button>
  </div>

  <div class="main">
    <div id="results" class="result-card" style="display:none;">
      <div id="msgOutput" class="queue-msg"></div>
    </div>
  </div>

  <script>
    let ROSTER = [];
    let PREFS = {};
    let CAPACITIES = [];

    async function init() {
      try {
        const [r, p, c] = await Promise.all([
          fetch('roster.json').then(res => res.json()),
          fetch('preferences.json').then(res => res.json()),
          fetch('capacities.json').then(res => res.json())
        ]);
        ROSTER = r;
        PREFS = p;
        CAPACITIES = c;
        document.getElementById('loading').style.display = 'none';
      } catch (e) {
        document.getElementById('loading').innerText = "Error loading JSON files. Make sure they are in the same folder.";
      }
    }

    function runAnalysis() {
      const searchVal = document.getElementById('pilotSearch').value.trim();
      const tBase = document.getElementById('targetBase').value;
      const tSeat = document.getElementById('targetSeat').value;

      // 1. Find User
      const user = ROSTER.find(p => p.sen.toString() === searchVal);
      if (!user) { alert("Pilot seniority number not found."); return; }

      // 2. Count everyone senior to you who wants this base
      let competitors = 0;
      ROSTER.forEach(p => {
        if (p.sen < user.sen) {
          const prefData = PREFS[p.id];
          if (!prefData || !prefData.preferences) return;

          const curBase = p.current.base;
          const curSeat = p.current.seat;

          for (let bid of prefData.preferences) {
            // Bid format: "73G SEA FO"
            const parts = bid.split(' ');
            const bBase = parts[1];
            const bSeat = parts[2];

            if (bBase === tBase && bSeat === tSeat) {
              competitors++;
              break;
            }
            // If they hit their current seat first, they aren't moving
            if (bBase === curBase && bSeat === curSeat) break;
          }
        }
      });

      // 3. Get Capacity Delta
      const cap = CAPACITIES.find(c => c.base === tBase && c.seat === tSeat) || { delta: 0 };
      const delta = cap.delta;

      // 4. Final Count
      const totalInLine = competitors + 1; // Senior people + You
      const diff = totalInLine - delta;

      // 5. Output
      const output = document.getElementById('msgOutput');
      document.getElementById('results').style.display = 'block';

      if (diff <= 0) {
        output.innerHTML = `There are <span class="highlight">${totalInLine}</span> people in line for that base.<br><span style="color:#22c55e">You are projected to get in!</span>`;
      } else {
        output.innerHTML = `There are <span class="highlight">${totalInLine}</span> people in line for that base. You'll need <span class="needed">${diff} more openings</span> or <span class="needed">${diff} people to leave</span>.`;
      }
    }

    init();
  </script>
</body>
</html>
