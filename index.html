<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>ProTrace Mobile - Rebuilt</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-app: #0f172a; --bg-panel: #1e293b; --bg-input: #020617; 
      --border: #334155; --text-main: #f1f5f9; --text-muted: #94a3b8; 
      --accent: #3b82f6; --success: #10b981; --danger: #ef4444;
      --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
    }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg-app); color: var(--text-main); 
      font-family: var(--font-ui); display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }
    .app-grid { display: grid; grid-template-columns: 360px 1fr; height: 100%; overflow: hidden; }
    .sidebar { background: var(--bg-panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; z-index: 10; }
    .main { padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; background: var(--bg-app); }
    
    .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
    .panel-title { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em; }
    
    input, select { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; width: 100%; margin-bottom: 10px; font-size: 14px; }
    button { padding: 14px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; width: 100%; }
    .btn-run { background: var(--accent); color: white; font-size: 16px; margin-top: 10px; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }
    .btn-run:active { transform: translateY(2px); opacity: 0.9; }

    /* Preference Selector Styles */
    .pref-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .pref-num { width: 24px; font-size: 12px; color: var(--accent); font-weight: 800; text-align: center; }

    /* Results Dashboard */
    .cutoff-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; font-family: var(--font-code); }
    .cutoff-card { background: var(--bg-input); padding: 12px; border-radius: 6px; border-bottom: 3px solid var(--success); }
    .cutoff-val { font-size: 20px; font-weight: bold; color: var(--success); }
    
    .status-banner { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; display: none; }
    .ledger-box { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; flex-grow: 1; overflow-y: auto; padding: 15px; font-family: var(--font-code); font-size: 12px; }

    @media (max-width: 768px) {
      .app-grid { grid-template-columns: 1fr; overflow-y: auto; }
      .sidebar { width: 100%; border-right: none; height: auto; }
      .main { height: auto; overflow: visible; padding-bottom: 100px; }
      .ledger-box { height: 400px; }
    }
  </style>
</head>
<body>

<div class="app-grid">
  <div class="sidebar">
    <div style="font-size: 22px; font-weight: 800; letter-spacing: -0.5px;">PRO<span style="color:var(--accent)">TRACE</span> <span style="font-weight:400; font-size:14px; color:var(--text-muted)">v2.0</span></div>
    
    <div class="panel">
      <div class="panel-title">1. Personal Info</div>
      <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">YOUR SENIORITY</label>
      <input id="userSen" type="number" placeholder="e.g. 2302" value="2302">
    </div>

    <div class="panel">
      <div class="panel-title">2. Bid Preferences</div>
      <div id="prefContainer">
        <div class="pref-row"><span class="pref-num">1</span>
          <select id="p1-base"><option>SAN</option><option selected>SFO</option><option>ANC</option><option>SEA</option><option>PDX</option><option>LAX</option></select>
          <select id="p1-seat"><option selected>CA</option><option>FO</option></select>
        </div>
        <div class="pref-row"><span class="pref-num">2</span>
          <select id="p2-base"><option selected>SAN</option><option>SFO</option><option>ANC</option><option>SEA</option></select>
          <select id="p2-seat"><option selected>CA</option><option>FO</option></select>
        </div>
        <div class="pref-row"><span class="pref-num">3</span>
          <select id="p3-base"><option>SAN</option><option>SFO</option><option selected>ANC</option><option>SEA</option></select>
          <select id="p3-seat"><option selected>CA</option><option>FO</option></select>
        </div>
      </div>
    </div>

    <button class="btn-run" onclick="runEngine()">RUN BID SIMULATION</button>
    <div id="statusMsg" style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:8px;">Ready to process roster...</div>
  </div>

  <div class="main">
    <div id="cutoffDashboard" class="panel" style="display:none; border-color: var(--success); background: rgba(16, 185, 129, 0.05);">
      <div class="panel-title" style="color:var(--success)">Junior-Most Award Cutoffs</div>
      <div id="cutoffList" class="cutoff-grid"></div>
    </div>

    <div id="summaryBox" class="status-banner">
      <div style="font-weight:800; color:var(--accent); margin-bottom:10px; display:flex; justify-content:space-between;">
        <span>BID STATUS ANALYSIS</span>
        <span id="resSen" style="color:white; opacity:0.6;"></span>
      </div>
      <div id="summaryText" style="line-height: 1.8; font-size: 14px;"></div>
    </div>

    <div class="panel-title">Transaction Ledger</div>
    <div class="ledger-box" id="ledger">
      <div style="color:var(--text-muted); text-align:center; padding-top:60px;">Simulation results will appear here.</div>
    </div>
  </div>
</div>

<script>
let roster = [], preferences = {}, capacities = [];

// Load Data on Startup
async function init() {
    const fetchJson = async (p) => {
        try { const r = await fetch(p); return r.ok ? await r.json() : null; } 
        catch(e) { return null; }
    };
    
    roster = await fetchJson('roster.json') || [];
    preferences = await fetchJson('preferences.json') || {};
    capacities = await fetchJson('capacities.json') || [];
    
    if(roster.length === 0) {
        document.getElementById('statusMsg').textContent = "Error: Local JSON files not found.";
        document.getElementById('statusMsg').style.color = "var(--danger)";
    }
}

function runEngine() {
    const userSen = Number(document.getElementById('userSen').value);
    const myPrefs = [
        { base: document.getElementById('p1-base').value, seat: document.getElementById('p1-seat').value },
        { base: document.getElementById('p2-base').value, seat: document.getElementById('p2-seat').value },
        { base: document.getElementById('p3-base').value, seat: document.getElementById('p3-seat').value }
    ];

    document.getElementById('statusMsg').textContent = "Simulating Awards...";
    
    // 1. Initialize Vacancies
    let vacancies = {};
    capacities.forEach(c => vacancies[`${c.base}__${c.seat}`] = Number(c.delta || 0));

    let cutoffs = {}; 
    let awardedList = [];

    // 2. Sort Roster by Seniority (1 = Most Senior)
    const sorted = roster.sort((a,b) => Number(a.sen) - Number(b.sen));

    // 3. Process Awards
    for (let p of sorted) {
        const pSen = Number(p.sen);
        
        // Use manual UI prefs for current user, otherwise use preferences.json
        const pPrefs = (pSen === userSen) ? myPrefs : (preferences[pSen]?.preferences || []);

        for (let bid of pPrefs) {
            const key = `${bid.base}__${bid.seat}`;
            
            if (vacancies[key] > 0) {
                vacancies[key]--;
                awardedList.push({ sen: pSen, name: p.name, to: key });
                
                // Track "Junior-Most" (The highest number awarded so far)
                cutoffs[key] = Math.max(cutoffs[key] || 0, pSen);
                break; 
            }
        }
    }

    render(userSen, myPrefs, cutoffs, awardedList);
}

function render(userSen, myPrefs, cutoffs, awardedList) {
    const cutoffDashboard = document.getElementById('cutoffDashboard');
    const cutoffList = document.getElementById('cutoffList');
    const summaryBox = document.getElementById('summaryBox');
    const summaryText = document.getElementById('summaryText');
    const ledger = document.getElementById('ledger');

    cutoffDashboard.style.display = 'block';
    summaryBox.style.display = 'block';
    document.getElementById('resSen').textContent = "PILOT #" + userSen;

    // 1. Render Cutoff Line Dashboard
    cutoffList.innerHTML = Object.entries(cutoffs).sort().map(([key, sen]) => {
        const [b, s] = key.split('__');
        return `<div class="cutoff-card">
            <div style="font-size:10px; color:var(--text-muted); font-weight:800;">${b} ${s}</div>
            <div class="cutoff-val">${sen}</div>
        </div>`;
    }).join('');

    // 2. Render Personal Gap Analysis
    let html = "";
    myPrefs.forEach((p, i) => {
        const key = `${p.base}__${p.seat}`;
        const cutoff = cutoffs[key] || 0;
        const gap = userSen - cutoff;

        if (cutoff > 0 && userSen <= cutoff) {
            html += `<div>Choice #${i+1} (${p.base} ${p.seat}): <b style="color:var(--success)">HOLDING</b> (Cutoff: ${cutoff})</div>`;
        } else {
            const statusLabel = (cutoff === 0) ? "No vacancies" : `NEED ${gap} NUMBERS`;
            html += `<div>Choice #${i+1} (${p.base} ${p.seat}): <b style="color:var(--danger)">${statusLabel}</b> (Junior-most: ${cutoff || 'N/A'})</div>`;
        }
    });
    summaryText.innerHTML = html;

    // 3. Render Ledger
    ledger.innerHTML = awardedList.map(a => 
        `<div style="padding:4px 0; border-bottom:1px solid #1e293b; display:flex; justify-content:space-between;">
            <span><b style="color:var(--accent)">${a.sen}</b> ${a.name.split(',')[0]}</span>
            <span style="color:var(--text-muted)">â†’ ${a.to.replace('__',' ')}</span>
        </div>`
    ).join('');

    document.getElementById('statusMsg').textContent = "Simulation Complete";
}

init();
</script>
</body>
</html>
