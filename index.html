<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUILD‑V10 — 2025-09-25 03:54:40 UTC — CSV export + vacancy-correct + BPL + self-bid=stay</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#8aa4c1; --text:#eaf2ff; --accent:#8ad2ff; --border:#1f2a44; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1240px;margin:18px auto;padding:0 12px 42px}
    h1{font-size:22px;margin:0 0 10px;color:#8ad2ff}
    .banner{background:#42320e;border-bottom:3px solid #ffd166;color:#fff;padding:10px 12px;font-weight:800;border-radius:0 0 12px 12px;letter-spacing:.3px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0}
    button{background:#2e4a78;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.secondary{background:#203453}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    td{background:#0f182a;border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
    .basehdr{background:#13213a;color:#cfe6ff;font-weight:700}
    input[type=number]{width:90px;padding:6px;border-radius:8px;border:1px solid var(--border);background:#0b1426;color:#eaf2ff;font-size:14px}
    .buts>button{padding:4px 8px;border-radius:8px;margin-left:2px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a2a47;color:#c8ddff;font-size:12px;margin-right:6px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;background:#12203b;color:#cfe6ff}
    .tag.up{background:#12361f}
    .tag.down{background:#3b1212}
    .tag.lat{background:#1b2c3b}
    .togglebar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:8px}
    .switch{display:inline-flex;align-items:center;gap:8px;background:#0e1a2f;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    a.button{background:#2e4a78;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;text-decoration:none}
  </style>
</head>
<body>
  <div class="banner">BUILD‑V10 — 2025-09-25 03:54:40 UTC — CSV export + vacancy-correct + BPL + self-bid=stay</div>
  <div class="wrap">
    <h1>Position Bid Simulator</h1>

    <div class="card">
      <div class="toolbar">
        <button id="runBtn">Run Simulation</button>
        <button class="secondary" id="resetBtn">Reset All Δ</button>
        <button class="secondary" id="validateBtn">Validate Data</button>
        <span id="status" style="margin-left:8px;color:var(--muted);"></span>
      </div>
      <div id="capTable"></div>
    </div>

    <div class="card">
      <h3>Summary</h3>
      <div id="summary"></div>
    </div>

    <div class="card">
      <h3>Moves</h3>
      <div id="movesHeader" style="margin-bottom:6px"></div>
      <div id="results"></div>
      <div class="togglebar">
        <div>
          <label class="switch"><input type="checkbox" id="upgradesOnly"> Show upgrades only</label>
          <button class="secondary" id="showAllBtn">Show all moves</button>
        </div>
        <a id="exportCsv" class="button" href="#" download="base_changers.csv">Export base changers to CSV</a>
      </div>
    </div>
  </div>

  <script>
    let capacitiesRaw = [];
    let roster = [];
    let prefs = {};

    function normalizeBase(base){ return String(base||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }
    function normalizeSeat(seat){
      const s = String(seat||'').toUpperCase();
      if (/(^|[^A-Z])F\/?O([^A-Z]|$)/.test(s) || /FIRST[\s\-_]*OFFICER/.test(s) || /CO[\s\-_]*PILOT/.test(s)) return 'FO';
      if (/(^|[^A-Z])CA([^A-Z]|$)/.test(s) || /CAPT(AIN)?/.test(s) || /\bCPT\b/.test(s)) return 'CA';
      return null;
    }
    const keyOf = (b,s)=>`${normalizeBase(b)}__${normalizeSeat(s)}`;

    const capMap = new Map();

    async function loadAll(){
      async function safeFetch(path){ try { const r = await fetch(path, {cache:'no-cache'}); if(!r.ok) throw 0; return r.json(); } catch{ return null; } }
      capacitiesRaw = await safeFetch('capacities.json') || await safeFetch('capacities.json.txt') || await safeFetch('data/capacities.json') || await safeFetch('data/capacities.json.txt');
      roster        = await safeFetch('roster.json')      || await safeFetch('data/roster.json');
      prefs         = await safeFetch('preferences.json') || await safeFetch('data/preferences.json');
      document.getElementById('status').textContent = (!!capacitiesRaw && !!roster && !!prefs) ? 'Loaded JSON.' : '❌ Missing JSON';
      rebuildCapMap();
      renderCapTable();
    }

    function rebuildCapMap(){
      const agg = new Map();
      for (const c of capacitiesRaw){
        const nb = normalizeBase(c.base); const ns = normalizeSeat(c.seat);
        if(!nb || !ns) continue;
        const start = (c.startCapacity||0) + (+c.delta||0);
        const k = `${nb}__${ns}`;
        agg.set(k, (agg.get(k)||0) + start);
      }
      capMap.clear();
      for (const [k, totalStart] of agg.entries()){
        const [b,s] = k.split('__');
        capMap.set(k, { base:b, seat:s, start: totalStart, delta: 0 });
      }
    }

    function groupByBase(){
      const bases = {};
      for(const {base, seat} of capMap.values()){
        if(!bases[base]) bases[base] = [];
        bases[base].push(seat);
      }
      const orderSeat = (a,b)=> (a===b?0 : a==='CA'? -1 : b==='CA'? 1 : a.localeCompare(b));
      return Object.keys(bases).sort().map(base=>({ base, seats: Array.from(new Set(bases[base])).sort(orderSeat) }));
    }

    function renderCapTable(){
      const groups = groupByBase();
      let html = '<table><thead><tr><th>Base</th><th>Seat</th><th>Start</th><th>Δ</th><th>Adjusted</th><th></th></tr></thead><tbody>';
      for(const g of groups){
        const rowSpan = g.seats.length;
        g.seats.forEach((seat, idx)=>{
          const k = `${g.base}__${seat}`;
          const cap = capMap.get(k) || {start:0, delta:0};
          const adj = Math.max(0, cap.start + cap.delta);
          html += '<tr>';
          if(idx===0){ html += `<td class="basehdr" rowspan="${rowSpan}">${g.base}</td>`; }
          html += `<td>${seat}</td>`;
          html += `<td class="mono">${cap.start}</td>`;
          html += `<td><input type="number" value="${cap.delta}" oninput="onDelta('${k}', this.value)"></td>`;
          html += `<td class="mono">${adj}</td>`;
          html += `<td class="buts">`
               +  `<button onclick="bump('${k}',-10)">-10</button>`
               +  `<button onclick="bump('${k}',-5)">-5</button>`
               +  `<button onclick="bump('${k}',-1)">-1</button>`
               +  `<button onclick="bump('${k}',+1)">+1</button>`
               +  `<button onclick="bump('${k}',+5)">+5</button>`
               +  `<button onclick="bump('${k}',+10)">+10</button>`
               +  `</td>`;
          html += '</tr>';
        });
      }
      html += '</tbody></table>';
      document.getElementById('capTable').innerHTML = html;
    }

    function onDelta(k, v){ const cap = capMap.get(k); if(!cap) return; const n = parseInt(v||'0',10); cap.delta = Number.isFinite(n)? n : 0; renderCapTable(); }
    function bump(k, d){ const cap = capMap.get(k); if(!cap) return; cap.delta = (cap.delta|0) + d; renderCapTable(); }

    // ----------------- Simulation (vacancy-correct + personal BPL + self-bid=stay) -----------------
    function run(){
      const adjusted = new Map();
      const incumbents = new Map();
      for(const [k, cap] of capMap.entries()) adjusted.set(k, Math.max(0, cap.start + cap.delta));
      const bkey = (b,s)=>{ const nb=normalizeBase(b), ns=normalizeSeat(s); return (nb&&ns)? `${nb}__${ns}`:null; };
      for(const p of roster){ const k=bkey((p.current||{}).base,(p.current||{}).seat); if(k) incumbents.set(k,(incumbents.get(k)||0)+1); }

      const remain = new Map();
      for(const [k, adj] of adjusted.entries()){
        const inc = incumbents.get(k)||0;
        remain.set(k, Math.max(0, adj - inc));
      }
      const fill = new Map(incumbents);

      const sorted = [...roster].sort((a,b)=>a.sen - b.sen);
      const assignments = new Map();
      const moves = [];
      let unassigned = 0;

      function canTakeWithBpl(tgtKey, personalBpl){ if(!personalBpl || personalBpl === 0) return true; const myRank = (fill.get(tgtKey)||0) + 1; return myRank <= personalBpl; }
      function tryMove(fromB, fromS, toB, toS){
        const fromK=bkey(fromB,fromS), toK=bkey(toB,toS);
        if(!fromK || !toK) return null;
        if(fromK===toK) return { base:toK.split('__')[0], seat:toK.split('__')[1], moved:false, fromB:fromK.split('__')[0], fromS:fromK.split('__')[1] };
        const r = remain.get(toK)||0; if(r<=0) return null;
        remain.set(toK, r-1); fill.set(toK,(fill.get(toK)||0)+1);
        fill.set(fromK, Math.max(0,(fill.get(fromK)||0)-1)); remain.set(fromK,(remain.get(fromK)||0)+1);
        return { base:toK.split('__')[0], seat:toK.split('__')[1], moved:true, fromB:fromK.split('__')[0], fromS:fromK.split('__')[1] };
      }

      for(const p of sorted){
        const curB=(p.current||{}).base, curS=(p.current||{}).seat; const curK=bkey(curB,curS);
        const pref=(prefs[p.id]?.preferences)||[];
        const bids = pref.filter(x=>x.stay!==true);
        let chosen=null, moved=false, moveRec=null;
        if(bids.length){
          const wanted=bids.sort((a,b)=>(a.order||0)-(b.order||0));
          for(const w of wanted){
            const tgtK=bkey(w.base,w.seat); if(!tgtK) continue;
            const pb=(w.bpl_min||0);
            if(tgtK!==curK && !canTakeWithBpl(tgtK,pb)) continue;
            const res=tryMove(curB,curS,w.base,w.seat); if(res){ chosen={base:res.base, seat:res.seat}; moved=!!res.moved; moveRec=res; break; }
          }
        }
        if(!chosen && curK){ const res={ base:curK.split('__')[0], seat:curK.split('__')[1], moved:false, fromB:curK.split('__')[0], fromS:curK.split('__')[1] }; chosen={base:res.base, seat:res.seat}; moveRec=res; moved=false; }
        if(!chosen){ unassigned++; continue; }
        const fromB=normalizeBase(curB), fromS=normalizeSeat(curS);
        const toB=chosen.base, toS=chosen.seat;
        assignments.set(p.id,chosen);
        if(moved && (toB!==fromB || toS!==fromS)){
          let type='lateral', tagClass='lat', tag='[Lateral]';
          if(fromS==='FO' && toS==='CA'){ type='upgrade'; tagClass='up'; tag='[Upgrade]'; }
          else if(fromS==='CA' && toS==='FO'){ type='downgrade'; tagClass='down'; tag='[Downgrade]'; }
          moves.push({sen:p.sen,id:p.id,name:p.name||'',fromB,fromS,toB,toS,type,tagClass,tag});
        }
      }

      const counts={upgrade:0,lateral:0,downgrade:0}; moves.forEach(m=>counts[m.type]++);
      const header = `<div class="pill">Total moves: ${moves.length}</div>`+
                     `<div class="pill">Upgrades: ${counts.upgrade}</div>`+
                     `<div class="pill">Laterals: ${counts.lateral}</div>`+
                     `<div class="pill">Downgrades: ${counts.downgrade}</div>`+
                     (unassigned>0?`<div class="pill" style="background:#3a1e1e">Unassigned: ${unassigned}</div>`:'');
      document.getElementById('movesHeader').innerHTML = header;

      function render(upgradesOnly){
        let list = moves;
        if(upgradesOnly) list = moves.filter(m=>m.type==='upgrade');
        let html = '<ol>';
        for(const m of list){ html += `<li>${m.sen} ${m.name}: ${m.fromB} ${m.fromS} → <b>${m.toB} ${m.toS}</b> <span class="tag ${m.tagClass}">${m.tag}</span></li>`; }
        html += '</ol>';
        document.getElementById('results').innerHTML = html;
      }

      const cb = document.getElementById('upgradesOnly');
      const showAllBtn = document.getElementById('showAllBtn');
      cb.onchange = ()=>render(cb.checked);
      showAllBtn.onclick = ()=>{ cb.checked=false; render(false); };
      render(false);

      // CSV export: base changers only
      function toCsv(rows){
        const esc = v => '"' + String(v).replaceAll('"','""') + '"';
        const header = ['sen','id','name','from_base','from_seat','to_base','to_seat','move_type'];
        const body = rows.map(r=>[r.sen,r.id||'',r.name||'',r.fromB,r.fromS,r.toB,r.toS,r.type].map(esc).join(','));
        return [header.join(','), ...body].join('\n');
      }
      const baseChangers = moves.filter(m=>m.fromB!==m.toB);
      const csvBlob = new Blob([toCsv(baseChangers)], {type:'text/csv'});
      const url = URL.createObjectURL(csvBlob);
      const a = document.getElementById('exportCsv');
      a.href = url;
      a.download = 'base_changers.csv';

      document.getElementById('status').textContent = 'Simulation complete.';
    }

    document.getElementById('runBtn').addEventListener('click', run);
    document.getElementById('resetBtn').addEventListener('click', ()=>{ for(const cap of capMap.values()) cap.delta=0; renderCapTable(); document.getElementById('status').textContent='Δ reset to 0.'; });
    document.getElementById('validateBtn').addEventListener('click', ()=>{});
    loadAll();
  </script>
</body>
</html>
