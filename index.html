<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTrace Seniority Calculator</title>
  <style>
    :root {
      --bg: #0b0f16; --card: #121a27; --accent: #2a66ff;
      --text: #e8eefc; --border: rgba(255,255,255,.1);
    }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 1100px; margin: 0 auto; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    label { display: block; font-size: 11px; font-weight: 700; opacity: .6; text-transform: uppercase; margin-bottom: 8px; }
    input, select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.1); background: #0d1420; color: white; }
    button { background: var(--accent); border: none; font-weight: 800; cursor: pointer; margin-top: 10px; }
    .big-num { font-size: 36px; font-weight: 900; color: var(--accent); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
    th { color: var(--accent); text-transform: uppercase; font-size: 11px; }
    .status-pill { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: rgba(42, 102, 255, 0.2); }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>ProTrace Analytics</h2>
      <div class="grid">
        <div>
          <label>Your Seniority #</label>
          <input id="senInput" type="number" placeholder="e.g. 2670">
        </div>
        <div>
          <label>Target Base</label>
          <select id="baseSelect">
            <option value="ANC">ANC</option><option value="LAX">LAX</option>
            <option value="PDX">PDX</option><option value="SAN">SAN</option>
            <option value="SEA">SEA</option><option value="SFO">SFO</option>
          </select>
        </div>
        <div>
          <label>Target Seat</label>
          <select id="seatSelect">
            <option value="CA">Captain (CA)</option>
            <option value="FO">First Officer (FO)</option>
          </select>
        </div>
      </div>
      <button id="calcBtn">Run Standing Analysis</button>
    </div>

    <div class="grid">
      <div class="card" style="text-align:center;">
        <label>Numbers Away (Delta)</label>
        <div id="deltaResult" class="big-num">-</div>
      </div>
      <div class="card" style="text-align:center;">
        <label>Total In Line</label>
        <div id="lineResult" class="big-num">-</div>
      </div>
      <div class="card" style="text-align:center;">
        <label>Base Capacity Delta</label>
        <div id="capResult" class="big-num">-</div>
      </div>
    </div>

    <div class="card">
      <label>Senior Competitors (Who is cutting you?)</label>
      <table>
        <thead>
          <tr>
            <th>Sen</th>
            <th>Name</th>
            <th>Current Status</th>
            <th>Bid Rank</th>
            <th>Full Preference</th>
          </tr>
        </thead>
        <tbody id="competitorTable"></tbody>
      </table>
    </div>
  </div>

<script>
let ROSTER = [], PREFS = {}, CAPACITIES = [];

async function loadData() {
  [ROSTER, PREFS, CAPACITIES] = await Promise.all([
    fetch('./roster.json').then(res => res.json()),
    fetch('./preferences.json').then(res => res.json()),
    fetch('./capacities.json').then(res => res.json())
  ]);
}

function runAnalysis() {
  const mySen = parseInt(document.getElementById("senInput").value);
  const tBase = document.getElementById("baseSelect").value;
  const tSeat = document.getElementById("seatSelect").value;
  const target = `${tBase} ${tSeat}`;

  const user = ROSTER.find(p => parseInt(p.sen) === mySen);
  if (!user) return alert("Pilot not found!");

  const competitors = [];
  ROSTER.forEach(p => {
    const pSen = parseInt(p.sen);
    if (pSen >= mySen) return;

    const pPref = PREFS[`pil${pSen}`] || PREFS[pSen];
    if (!pPref || !pPref.preferences) return;

    const curBase = p.base || (p.current ? p.current.base : "");
    const curSeat = p.seat || (p.current ? p.current.seat : "");
    const curStatus = `${curBase} ${curSeat}`.trim();

    for (const bid of pPref.preferences) {
      const bidStr = String(bid.bid || "");
      const bidOrder = parseInt(bid.order);

      // Rule: If Order 1 is stay or empty, ignore pilot
      if (bidOrder === 1 && (bidStr === "" || bidStr.includes(curStatus))) break;
      
      // Rule: If bid matches target and they don't already hold it
      if (bidStr.includes(tBase) && bidStr.includes(tSeat)) {
        if (!bidStr.includes(curStatus)) {
          competitors.push({ sen: pSen, name: p.name, current: curStatus, order: bidOrder, full: bidStr });
        }
        break;
      }
      
      // Rule: Stop if they hit their current position in their list
      if (bidStr.includes(curStatus)) break;
    }
  });

  const capacity = CAPACITIES.find(c => c.base === tBase && c.seat === tSeat)?.delta || 0;
  const totalInLine = competitors.length + 1;
  const deltaAway = Math.max(0, totalInLine - capacity);

  document.getElementById("lineResult").textContent = totalInLine;
  document.getElementById("capResult").textContent = capacity;
  document.getElementById("deltaResult").textContent = deltaAway;

  document.getElementById("competitorTable").innerHTML = competitors.sort((a,b) => a.sen - b.sen).map(c => `
    <tr>
      <td>${c.sen}</td>
      <td>${c.name}</td>
      <td><span class="status-pill">${c.current}</span></td>
      <td>#${c.order}</td>
      <td>${c.full}</td>
    </tr>
  `).join("");
}

document.getElementById("calcBtn").addEventListener("click", runAnalysis);
loadData();
</script>
</body>
</html>
