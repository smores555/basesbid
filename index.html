<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BaseBid – In-Line Calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f16; color: #e8eefc; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { opacity: .85; margin-bottom: 18px; }
    .card { background: #121a27; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 14px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    label { display: block; font-size: 12px; opacity: .9; margin: 0 0 6px; }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: #0d1420; color: #e8eefc; }
    button { cursor: pointer; background: #2a66ff; border: none; font-weight: 700; }
    button:hover { filter: brightness(1.05); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); font-size: 12px; margin-right: 8px; }
    .big { font-size: 16px; font-weight: 800; }
    .muted { opacity: .8; }
    .ok { color: #7dff9a; font-weight: 800; }
    .no { color: #ff7d7d; font-weight: 800; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; overflow: hidden; border-radius: 12px; }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,.07); font-size: 13px; }
    th { text-align: left; opacity: .9; background: rgba(255,255,255,.04); }
    tr:hover td { background: rgba(255,255,255,.03); }
    .error { background: rgba(255, 80, 80, .12); border: 1px solid rgba(255,80,80,.25); padding: 10px 12px; border-radius: 12px; margin-top: 12px; display: none; }
    .note { font-size: 12px; opacity: .8; margin-top: 10px; line-height: 1.35; }
    code { background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BaseBid – In-Line Calculator</h1>
    <div class="sub">Counts “in line” only if a senior pilot lists the target <b>above</b> their current base/seat (or current isn’t listed → treated as stay/last).</div>

    <div class="grid">
      <div class="card">
        <div class="row3">
          <div>
            <label>Your Seniority #</label>
            <input id="seniorityInput" type="number" inputmode="numeric" placeholder="e.g. 501" />
          </div>
          <div>
            <label>Target Base</label>
            <select id="targetBaseSelect"></select>
          </div>
          <div>
            <label>Target Seat</label>
            <select id="targetSeatSelect">
              <option value="CA">CA</option>
              <option value="FO">FO</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>Openings (What-if)</label>
            <input id="openingsInput" type="number" inputmode="numeric" value="0" />
          </div>
          <div style="display:flex;align-items:end;">
            <button id="runBtn">Run</button>
          </div>
        </div>

        <div id="errBox" class="error"></div>

        <div class="note">
          Files required in same folder as <code>index.html</code>: <code>roster.json</code>, <code>preferences.json</code><br/>
          GitHub Pages project sites should use a trailing slash: <code>.../basesbid/</code>
        </div>
      </div>

      <div class="card">
        <div id="resultsHeadline" class="big">Enter inputs and click Run.</div>
        <div style="margin-top:10px;">
          <span class="pill">You: <span id="pilotName" class="muted">-</span> <span id="pilotSeniority" class="muted"></span></span>
          <span class="pill">Current: <span id="pilotCurrent" class="muted">-</span></span>
          <span class="pill">Target: <span id="pilotTarget" class="muted">-</span></span>
        </div>

        <div style="margin-top:12px;" class="row3">
          <div class="pill">Competitors ahead: <span id="competitorsCount" class="big">-</span></div>
          <div class="pill">Your position: <span id="yourPosition" class="big">-</span></div>
          <div class="pill">Clear w/ openings? <span id="clearFlag" class="big">-</span></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Sen</th>
              <th>Name</th>
              <th>Current</th>
              <th>Target Rank vs Current</th>
            </tr>
          </thead>
          <tbody id="competitorsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* =========================
   Inline JS so you only manage one file.
   Rule:
   A senior pilot counts if they bid the target AND the target is above their current bid
   in their preference ordering (or current missing => treated as stay/last).
   ========================= */

const ROSTER_URL = "./roster.json";
const PREFS_URL  = "./preferences.json";

const elSen   = document.getElementById("seniorityInput");
const elBase  = document.getElementById("targetBaseSelect");
const elSeat  = document.getElementById("targetSeatSelect");
const elOpen  = document.getElementById("openingsInput");
const elRun   = document.getElementById("runBtn");
const errBox  = document.getElementById("errBox");

const elResultsHeadline  = document.getElementById("resultsHeadline");
const elPilotName        = document.getElementById("pilotName");
const elPilotSeniority   = document.getElementById("pilotSeniority");
const elPilotCurrent     = document.getElementById("pilotCurrent");
const elPilotTarget      = document.getElementById("pilotTarget");
const elCompetitorsCount = document.getElementById("competitorsCount");
const elYourPosition     = document.getElementById("yourPosition");
const elClearFlag        = document.getElementById("clearFlag");
const elTableBody        = document.getElementById("competitorsTableBody");

function showError(msg) {
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function clearError() {
  errBox.style.display = "none";
  errBox.textContent = "";
}

function normStr(x){ return (x ?? "").toString().trim(); }
function toNum(x, fb=NaN){ const n = Number(x); return Number.isFinite(n) ? n : fb; }
function makeBid(base, seat){ return `${normStr(base)} ${normStr(seat)}`.trim(); }

async function loadJson(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to fetch ${url} (${res.status})`);
  return await res.json();
}

// Normalize roster to array of { sen, name, base, seat }
function normalizeRoster(raw) {
  const arr = Array.isArray(raw) ? raw : Object.values(raw || {});
  return arr.map(p => {
    const sen = toNum(p.sen ?? p.seniority ?? p.sen_num, NaN);
    const name = normStr(p.name);
    let base = normStr(p.base);
    let seat = normStr(p.seat);

    const current = normStr(p.current);
    if ((!base || !seat) && current) {
      const parts = current.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) {
        base = parts[parts.length - 2];
        seat = parts[parts.length - 1];
      }
    }
    return { ...p, sen, name, base, seat };
  }).filter(p => Number.isFinite(p.sen));
}

// Normalize preferences to array of { sen, name, preferences: [...] }
function normalizePrefs(raw) {
  const obj = raw && typeof raw === "object" ? raw : {};
  return Object.values(obj)
    .map(p => ({
      sen: toNum(p?.sen, NaN),
      name: normStr(p?.name),
      preferences: Array.isArray(p?.preferences) ? p.preferences : []
    }))
    .filter(p => Number.isFinite(p.sen));
}

function isNonStayPref(p) {
  const order = toNum(p?.order, 0);
  const bid = normStr(p?.bid);
  return order > 0 && bid !== "";
}

function sortedPrefs(prefs) {
  if (!Array.isArray(prefs)) return [];
  return prefs
    .map(p => ({ order: toNum(p?.order, 0), bid: normStr(p?.bid) }))
    .filter(isNonStayPref)
    .sort((a,b) => a.order - b.order);
}

function countsAsCompetitor(prefList, targetBid, currentBid) {
  const sp = sortedPrefs(prefList);

  const targetIdx = sp.findIndex(p => p.bid === targetBid);
  if (targetIdx === -1) return false; // not bidding target

  const currentIdx = sp.findIndex(p => p.bid === currentBid);
  const effectiveCurrentIdx = (currentIdx === -1) ? Infinity : currentIdx;

  // target must be above current/stay
  return targetIdx < effectiveCurrentIdx;
}

function setText(el, txt){ if (el) el.textContent = txt; }
function clearTable(){ elTableBody.innerHTML = ""; }

function addRow({ sen, name, current, detail }) {
  const tr = document.createElement("tr");
  const tdSen = document.createElement("td"); tdSen.textContent = sen;
  const tdName = document.createElement("td"); tdName.textContent = name;
  const tdCur = document.createElement("td"); tdCur.textContent = current;
  const tdDet = document.createElement("td"); tdDet.textContent = detail;
  tr.append(tdSen, tdName, tdCur, tdDet);
  elTableBody.appendChild(tr);
}

let roster = null;
let prefs = null;

async function ensureLoaded() {
  if (roster && prefs) return;
  const [rRaw, pRaw] = await Promise.all([loadJson(ROSTER_URL), loadJson(PREFS_URL)]);
  roster = normalizeRoster(rRaw);
  prefs = normalizePrefs(pRaw);

  // populate base dropdown from roster
  const bases = Array.from(new Set(roster.map(p => normStr(p.base)).filter(Boolean))).sort();
  elBase.innerHTML = bases.map(b => `<option value="${b}">${b}</option>`).join("");
}

function rosterPilotBySen(sen) {
  return roster.find(p => Number(p.sen) === Number(sen)) || null;
}
function prefsPilotBySen(sen) {
  return prefs.find(p => Number(p.sen) === Number(sen)) || null;
}
function currentBidForSen(sen) {
  const r = rosterPilotBySen(sen);
  return r ? makeBid(r.base, r.seat) : "";
}

function render({ you, targetBid, openings, competitors, yourPosition, clear }) {
  setText(elPilotName, you.name || "(you)");
  setText(elPilotSeniority, `#${you.sen}`);
  setText(elPilotCurrent, currentBidForSen(you.sen) || "-");
  setText(elPilotTarget, targetBid);

  setText(elCompetitorsCount, String(competitors.length));
  setText(elYourPosition, String(yourPosition));
  setText(elClearFlag, clear ? "YES" : "NO");
  elClearFlag.className = clear ? "ok" : "no";

  const shortBy = Math.max(0, yourPosition - openings);
  setText(elResultsHeadline,
    `There are ${competitors.length + 1} in line for ${targetBid} (including you). With ${openings} openings, you’re short by ${shortBy}.`
  );

  clearTable();
  competitors.forEach(c => addRow(c));
}

async function run() {
  clearError();
  await ensureLoaded();

  const youSen = toNum(elSen.value, NaN);
  const targetBase = normStr(elBase.value);
  const targetSeat = normStr(elSeat.value);
  const openings = Math.max(0, toNum(elOpen.value, 0));
  const targetBid = makeBid(targetBase, targetSeat);

  if (!Number.isFinite(youSen)) return showError("Enter a valid seniority number.");
  if (!targetBase || !targetSeat) return showError("Select a target base and seat.");

  const youRoster = rosterPilotBySen(youSen);
  const youPrefs = prefsPilotBySen(youSen);
  const youName = (youPrefs?.name || youRoster?.name || "").trim();

  if (!youRoster) return showError(`Could not find you (#${youSen}) in roster.json`);
  if (!youPrefs) return showError(`Could not find you (#${youSen}) in preferences.json`);

  // Build competitor list
  const competitors = [];

  for (const p of prefs) {
    // only senior to you
    if (p.sen >= youSen) continue;

    const curBid = currentBidForSen(p.sen);
    if (!curBid) continue;

    // if already holding target, don't count as "in line"
    if (curBid === targetBid) continue;

    if (countsAsCompetitor(p.preferences, targetBid, curBid)) {
      const sp = sortedPrefs(p.preferences);
      const tIdx = sp.findIndex(x => x.bid === targetBid);
      const cIdx = sp.findIndex(x => x.bid === curBid);
      const detail = (cIdx === -1)
        ? `Target ranked above implicit stay`
        : `Target rank ${tIdx + 1} is above current rank ${cIdx + 1}`;

      competitors.push({
        sen: p.sen,
        name: p.name,
        current: curBid,
        detail
      });
    }
  }

  // Sort competitors by seniority (lowest number first = more senior)
  competitors.sort((a,b) => a.sen - b.sen);

  // Your position is competitors ahead + 1 (you)
  const yourPosition = competitors.length + 1;
  const clear = openings >= yourPosition;

  render({
    you: { sen: youSen, name: youName },
    targetBid,
    openings,
    competitors,
    yourPosition,
    clear
  });
}

elRun.addEventListener("click", () => run().catch(e => showError(e.message)));
</script>
</body>
</html>
