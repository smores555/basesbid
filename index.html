<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTrace â€“ Seniority Queue</title>
  <style>
    :root {
      --bg-app: #0b0f16; --bg-card: #121a27; --bg-input: #0d1420;
      --border: rgba(255,255,255,.1); --accent: #2a66ff;
      --text: #e8eefc; --success: #7dff9a; --danger: #ff7d7d;
    }
    body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg-app); color: var(--text); line-height: 1.5; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    
    label { display: block; font-size: 11px; font-weight: 700; opacity: .6; text-transform: uppercase; margin-bottom: 8px; }
    input, select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,.15); background: var(--bg-input); color: white; font-size: 14px; }
    button { cursor: pointer; background: var(--accent); border: none; font-weight: 800; margin-top: 10px; }

    .stat-box { text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid var(--border); }
    .big-num { font-size: 32px; font-weight: 900; color: var(--accent); display: block; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: left; }
    th { background: rgba(255,255,255,0.05); color: var(--accent); text-transform: uppercase; font-size: 11px; }
    
    .ok { color: var(--success); font-weight: 700; }
    .no { color: var(--danger); font-weight: 700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom: 20px;">
      <h1 style="margin:0;">ProTrace Base Analysis</h1>
      <p style="margin:0; opacity:0.6;">Cross-referencing Roster (Current) with Preferences (Bids)</p>
    </div>

    <div class="grid">
      <div class="card">
        <label>Your Seniority #</label>
        <input id="seniorityInput" type="number" placeholder="e.g. 2670" style="margin-bottom:15px;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
          <div>
            <label>Target Base</label>
            <select id="targetBaseSelect">
              <option value="ANC">ANC</option><option value="LAX">LAX</option>
              <option value="PDX">PDX</option><option value="SAN">SAN</option>
              <option value="SEA">SEA</option><option value="SFO">SFO</option>
            </select>
          </div>
          <div>
            <label>Target Seat</label>
            <select id="targetSeatSelect">
              <option value="CA">Captain (CA)</option>
              <option value="FO">First Officer (FO)</option>
            </select>
          </div>
        </div>
        
        <label>Openings</label>
        <input id="openingsInput" type="number" value="0">
        <button id="runBtn">Run Cross-Check</button>
      </div>

      <div class="card" style="display:flex; flex-direction:column; justify-content:center; gap:15px;">
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
          <div class="stat-box">
            <label>Position In Line</label>
            <span id="yourPosition" class="big-num">-</span>
          </div>
          <div class="stat-box">
            <label>Openings Required</label>
            <span id="neededNum" class="big-num">-</span>
          </div>
        </div>
        <div id="statusMsg" style="text-align:center; font-weight:600;"></div>
      </div>
    </div>

    <div class="card">
      <label>Queue Breakdown (Senior Competitors Only)</label>
      <table>
        <thead>
          <tr>
            <th>Sen</th>
            <th>Name</th>
            <th>Roster Status</th>
            <th>Bid Rank</th>
            <th>Target Bid</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
let ROSTER = [];
let PREFS = {};

// Extracts current info from roster.json
function getRosterStatus(p) {
  if (!p) return "";
  // Check common roster keys: base/seat or current.base/current.seat
  const base = p.base || (p.current ? p.current.base : "");
  const seat = p.seat || (p.current ? p.current.seat : "");
  return `${String(base).trim()} ${String(seat).trim()}`;
}

async function init() {
  try {
    const [r, p] = await Promise.all([
      fetch('./roster.json').then(res => res.json()),
      fetch('./preferences.json').then(res => res.json())
    ]);
    ROSTER = Array.isArray(r) ? r : Object.values(r);
    PREFS = p;
  } catch (e) {
    alert("Error loading data files. Check filenames and console.");
  }
}

function run() {
  const senInput = document.getElementById("seniorityInput").value;
  const tBase = document.getElementById("targetBaseSelect").value;
  const tSeat = document.getElementById("targetSeatSelect").value;
  const openings = parseInt(document.getElementById("openingsInput").value || 0);

  const user = ROSTER.find(p => String(p.sen) === senInput);
  if (!user) { alert("Pilot not found in roster!"); return; }

  const uSen = parseInt(user.sen);
  const competitors = [];

  ROSTER.forEach(pilot => {
    const pSen = parseInt(pilot.sen);
    if (pSen >= uSen) return; // Only competitors senior to you

    // Cross-check: Look up this pilot in the preferences JSON
    const pPrefObj = PREFS[`pil${pSen}`] || PREFS[pSen];
    if (!pPrefObj || !pPrefObj.preferences) return;

    // Get current status from Roster
    const curStatus = getRosterStatus(pilot);

    // Scan their bids in order
    for (const p of pPrefObj.preferences) {
      const bidStr = String(p.bid || "").trim();
      const bidOrder = parseInt(p.order);

      // STAY RULE: If Order 1 is current status or blank, they stay
      if (bidOrder === 1 && (bidStr === "" || bidStr.includes(curStatus))) break;

      // COMPETITOR RULE: If bid contains target base + seat
      if (bidStr.includes(tBase) && bidStr.includes(tSeat)) {
        if (!bidStr.includes(curStatus)) { // Only count if they are actually changing status
          competitors.push({
            sen: pSen,
            name: pilot.name,
            current: curStatus,
            order: bidOrder,
            fullBid: bidStr
          });
        }
        break; // Stop looking after finding their first applicable bid
      }

      // STOP RULE: If they list their current position, they stop looking further down
      if (bidStr.includes(curStatus)) break;
    }
  });

  // UI Updates
  const pos = competitors.length + 1;
  const needed = Math.max(0, pos - openings);
  document.getElementById("yourPosition").textContent = pos;
  document.getElementById("neededNum").textContent = needed;
  
  const msg = document.getElementById("statusMsg");
  msg.innerHTML = needed === 0 ? `<span class="ok">Holdable (Pos ${pos})</span>` : `<span class="no">Not Holdable (Need ${needed} more)</span>`;

  document.getElementById("tableBody").innerHTML = competitors.sort((a,b) => a.sen - b.sen).map(c => `
    <tr>
      <td>${c.sen}</td>
      <td>${c.name}</td>
      <td>${c.current}</td>
      <td>#${c.order}</td>
      <td>${c.fullBid}</td>
    </tr>
  `).join("");
}

document.getElementById("runBtn").addEventListener("click", run);
init();
</script>
</body>
</html>
